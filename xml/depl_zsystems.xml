<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE appendix
[
  <!ENTITY % entities SYSTEM "entity-decl.ent">
  %entities;
]>
<!-- Converted by suse-upgrade version 1.1 -->
<appendix xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" version="5.0" xml:id="app.deploy.zsystems">
 <title>IBM &zseries; Installation Instructions</title>
 <info>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:maintainer>fs</dm:maintainer>
   <dm:status>editing</dm:status>
   <dm:deadline/>
   <dm:priority/>
   <dm:translation>no</dm:translation>
   <dm:languages/>
  </dm:docmanager>
 </info>
 <para>
  &cloud; supports the &o_comp; ZVMDriver driver which manages communication
  between &ostack; and a z/VM hypervisor to deploy and manage &vmguest;s
  on z/VM. &productname; does not natively support managing and deploying z/VM
  &vmguest;s&mdash;it delegates requests to an &xcat; server running on
  z/VM. This requires a proper setup on the &zseries; side and a single
  &comp; node on the &cloud; side.
 </para>
 <para>
  IBM supports different ways to set up the &zseries; side. This document
  describes the <literal>CMA nm</literal> setup as described in the <link
  xlink:href="https://www.ibm.com/support/knowledgecenter/en/SSB27U_6.3.0/com.ibm.zvm.v630.hcpo4/cmoover.htm">IBM
  documentation</link>. It configures the z/VM Cloud Manager Appliance (CMA) to
  only run the Extreme Cloud Administration Toolkit (&xcat;) and the ZHCP
  services, because, all &ostack; services are running on external &cloud;
  servers.
 </para>
 <para>
  Additional documentation providing in-depth information to topics also
  covered in this document are available from IBM and can be retrieved from the
  IBM Knowledge Center for z/VM 6.3.0:
 </para>
 <itemizedlist>
  <listitem>
   <para>
    <link xlink:href="https://www.ibm.com/support/knowledgecenter/en/SSB27U_6.3.0/com.ibm.zvm.v630.hcpo4/toc.htm">z/VM Enabling z/VM for OpenStack (Support for OpenStack Liberty Release)</link>
   </para>
  </listitem>
  <listitem>
   <para>
    <link xlink:href="https://www.ibm.com/support/knowledgecenter/en/SSB27U_6.3.0/com.ibm.zvm.v630.dmse6/toc.htm">z/VM: Systems Management Application Programming</link>
   </para>
  </listitem>
 </itemizedlist>
 <para>
  Note, that these manuals contain procedures and setups not tested by
  &suse; or not working with &cloud;. Links to sections covering topics
  described in this manual are provided in the respective sections.
 </para>
 <sect1 xml:id="app.deploy.zsystems.setup">
  <title>IBM &zseries;: Supported Setup</title>
  <para>
   To manage and deploy &vmguest;s on z/VM with &cloud;, a z/VM running the CMA
   with the &xcat; and ZHCP services is required. You also need to set up a
   Linux system running &slsa; 12 SP2 that will be used to capture an image
   from. The setup described in this document uses the following components and
   configurations:
  </para>
  <itemizedlist>
   <listitem>
    <para>
     The &xcat; and the ZHCP servers are running in the CMA, all &ostack;
     services are running on external &cloud; servers. This setup is named
     <literal>CMA nm</literal>.
    </para>
   </listitem>
   <listitem>
    <para>
     Communication between &xcat; and &productname; is done by a single &cloud;
     &comp; node that is deployed and configured from &productname;. This
     &comp; node needs to be an <literal>x86_64</literal> machine.
    </para>
   </listitem>
   <listitem>
    <para>
     The Linux image capture system needs to run &slsa; 12 SP1 for IBM
     &zseries; and needs to use ECKD for storage. See <xref
     linkend="sec.deploy.zsystems.image"/> for a full list of requirements for
     this system.
    </para>
   </listitem>
  </itemizedlist>

  <remark condition="clarity">
   2016-09-22 - fs: Do we support live migration? (requires SSI setup)
   <link xlink:href="https://www.ibm.com/support/knowledgecenter/en/SSB27U_6.3.0/com.ibm.zvm.v630.hcpo4/zvmsys.htm"/>
  </remark>
  <remark condition="clarity">
   2016-09-22 - fs: Do we support multipath for persistent disks?
   <link xlink:href="https://www.ibm.com/support/knowledgecenter/en/SSB27U_6.3.0/com.ibm.zvm.v630.hcpo4/multipath.htm"/>
  </remark>
  <remark condition="clarity">
   2016-09-22 - fs: Which network configuration do we support?
   <link
     xlink:href="https://www.ibm.com/support/knowledgecenter/en/SSB27U_6.3.0/com.ibm.zvm.v630.hcpo4/networkcon.htm"/> ff.
  </remark>

 </sect1>
 <sect1 xml:id="app.deploy.zsystems.requirements">
  <title>IBM &zseries;: Requirements</title>
  <para>
   The following requirements must be met before you can start setting up the
   CMA, &xcat;, and the Linux image capture system:
  </para>
  <itemizedlist>
   <listitem>
    <para>
     Provide a z/VM 6.3.0 instance installed with SMAPI and DIRMAINT with the
     following setup:
    </para>
    <itemizedlist>
     <listitem>
      <para>
       The latest APARs and PTFs for z/VM &ostack; Liberty support from <link
       xlink:href="http://www.vm.ibm.com/sysman/osmntlvl.html"/> need to be
       installed. Note that this Web page offers APARS and PTFs for &ostack;
       Liberty and Juno. This setup requires them for &ostack; Liberty only.
      </para>
     </listitem>
     <listitem>
      <para>
       Provide seven preformatted Model 9 (or equivalent) system attached mini
       disks for the CMA. These disks will be used by &xcat; and be added to
       the disk pool XCAT1.
       <remark condition="clarity">
        2016-09-15 - fs: Where to find the README that explains how to set them
        up?
       </remark>
      </para>
      <para>
       <remark condition="clarity">
        2016-09-15 - fs: IIRC we did not use the 7 disks but rather:
       </remark>
       Provided two Model 3 (or equivalent) mini disks to be added to the system
       as <literal>M0101</literal> and <literal>M0102</literal>.
      </para>
     </listitem>
     <listitem>
      <para>
       Provide a single disk pool for disk space required for the
       &vmguest;s. It is not possible to use more than one disk pool for this
       purpose.
      </para>
     </listitem>
     <listitem>
      <para>
       &xcat; needs to be configured to have SMAPI access.
      </para>
     </listitem>
     <listitem>
      <para>
       Provide a real OSA device for &xcat;.
      </para>
     </listitem>
     <listitem>
      <para>
       Make sure to the IP address for &xcat; is accessible from within the
       company network (do not use an address from the &cloud; network or any
       other isolated network).
      </para>
     </listitem>
    </itemizedlist>
   </listitem>
  </itemizedlist>
 </sect1>

 <sect1 xml:id="app.deploy.zsystems.zvm">
  <title>Configuring z/VM</title>
  <para/>

  <remark condition="clarity">
   2016-09-22 - fs: Any differences to <link
   xlink:href="https://www.ibm.com/support/knowledgecenter/en/SSB27U_6.3.0/com.ibm.zvm.v630.hcpo4/config.htm"/> ??
  </remark>
 </sect1>

 <sect1 xml:id="app.deploy.zsystems.cma">
  <title>Configuring the CMA</title>
  <para>
   The CMA configuration is stored in the file <filename>DMSSICMO
   COPY</filename>. This section is about tailoring the default configuration
   to set up the CMA according to the CMA nm role (refer to <xref
   linkend="app.deploy.zsystems.setup"/> for details on this role).
  </para>
  <procedure xml:id="pro.deploy.zsystems.dmssicmo">
   <title>Adjusting <filename>DMSSICMO COPY</filename></title>
   <step>
    <para>
     Log on as user MAINT on the z/VM system.
    </para>
   </step>
   <step>
    <para>
     Shut down SMAPI with the following command:
    </para>
    <screen>FORCE VSMGUARD</screen>
   </step>
   <step>
    <para>
     Create a local copy of <filename>DMSSICMO COPY</filename> using the
     following command:
    </para>
    <screen>LOCALMOD CMS DMSSICNF $COPY</screen>
    <para>
     In the upcoming dialog, select <guimenu>1</guimenu>. An XEDIT session in
     which you can adjust the default settings of the <filename>DMSSICMO
     COPY</filename> file will automatically start.
    </para>
    <important>
     <title>File Location</title>
     <para>
      The <filename>DMSSICMO COPY</filename> needs to reside on MAINT 193.
     </para>
    </important>
   </step>
   <step>
    <para>
     Adjust the values listed below. Do not change values not listed below.
    </para>
    <variablelist>
     <varlistentry>
      <term><envar>cmo_data_disk</envar></term>
      <listitem>
       <para>
        A space-separated list of volume IDs of minidisks that are to be used
        by the CMA to store user data. These are the seven preformatted Model 9
        mini disks (FIXME) you provided for the CMA. See <xref
        linkend="qa.zsystem.add.disks"/> for detailed instructions.
       </para>
       <screen>cmo_data_disk="<replaceable>volumeID1</replaceable>
       <replaceable>volumeID2</replaceable> <replaceable>volumeID3</replaceable> <replaceable>...</replaceable></screen>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term><envar>openstack_system_role</envar></term>
      <listitem>
       <para>
        This option needs to be set to <literal>nm</literal> to configure the
        CMA nm role.
       </para>
       <screen>openstack_system_role="nm"</screen>
      </listitem>
     </varlistentry>
    </variablelist>
   </step>
   <step>
    <para>
     To save the <filename>DMSSICNF $COPY</filename> enter
     <literal>FILE</literal> followed by <keycap function="enter"/> on the
     XEDIT command line.
    </para>
   </step>
   <step>
    <para>
     Make the changes available by entering the following commands:
    </para>
    <screen>SERVICE CMS BUILD
PUT2PROD</screen>
   </step>
  </procedure>
  <para>
   The CMA is now configured. Proceed with <xref
   linkend="app.deploy.zsystems.xcat"/>.
  </para>
  </sect1>

 <sect1 xml:id="app.deploy.zsystems.xcat">
  <title>Configuring the &xcat; and ZHCP Servers</title>
  <para>
   Each &xcat; and CMA server requires a ZHCP server to communicate with
   SMAPI. Different setups are supported, however the configuration described
   in this document is a single z/VM running &xcat; and ZHCP in an integrated
   CMA (<literal>CMA nm</literal>). ZHCP is automatically started alongside
   &xcat; and both services are configured with the <filename>DMSSICNF
   COPY</filename> file.
  </para>
  <para>
   The <filename>DMSSICNF COPY</filename> file must reside on the MAINT 193
   disk only. Adjustments in the <filename>DMSSICNF COPY</filename> file should
   only be made locally using the automated local modification procedure. Make
   sure the server is not running when editing file.
   <remark condition="clarity">
    2016-09-22 - fs: Which server? How to stop it?
   </remark>
  </para>
  <procedure>
   <title>Adjusting <filename>DMSSICNF COPY</filename></title>
   <step>
    <para>
     Log on as user MAINT on the z/VM system.
    </para>
   </step>
   <step>
    <para>
     Create a local copy of <filename>DMSSICNF COPY</filename> using the
     following command:
    </para>
    <screen>LOCALMOD CMS DMSSICNF $COPY</screen>
    <para>
     In the upcoming dialog, select <guimenu>1</guimenu>. An XEDIT session in
     which you can adjust the default settings of the <filename>DMSSICNF
     COPY</filename> file will automatically start.
    </para>
   </step>
   <step>
    <para>
     Set values matching your network configuration for the &xcat; server
     running on this z/VM instance:
    </para>
    <simplelist>
     <member><envar>XCAT_MN_Addr</envar> (IP address).</member>
     <member><envar>XCAT_MN_gateway</envar> (gateway).</member>
     <member><envar>XCAT_MN_Mask</envar>(network mask).</member>
     <member>
      <envar>XCAT_DOMAIN</envar> and <envar>ZHCP_Domain</envar> (domain name
      for the &xcat; and the ZHCP servers, for example &exampledomain;).
     </member>
    </simplelist>
    <para>
     If you are running multiple &xcat; servers in your network, also set
     <envar>XCAT_Host</envar> to the host name of the server running on this
     z/VM instance.
    </para>
   </step>
   <step>
    <para>
     Set the value of <envar>XCAT_MN_OSAdev</envar> to the address of the real
     OSA device (first address of the triplet) of the &xcat; server. Note that
     you can only specify a single address here.
    </para>
   </step>
   <step>
    <para>
     It is recommended <emphasis>not</emphasis> to change the default values
     for
    </para>
    <simplelist>
     <member><envar>XCAT_vswitch</envar>=<literal>XCATVSW1</literal></member>
     <member>
      <envar>XCAT_MN_vswitch</envar>=<literal>XCATVSW2</literal>
     </member>
    </simplelist>
   </step>
   <step>
    <para>
     Set <envar>XCAT_zvmsysid</envar> to the id of this z/VM instance.
    </para>
   </step>
   <step>
    <para>
     Set <envar>XCAT_notify</envar> to the user ID that should receive start-up
     messages. If unset, these massages are automatically sent to <systemitem
     class="username">OPERATOR</systemitem>.
    </para>
   </step>
   <step>
    <para>
     <remark condition="clarity">
      2016-09-26 - fs: Is this true? I made a note that these are the
      credentials for the Web front-end rather than for SSH.
     </remark>
     Although optional, it is strongly recommended to enable connecting via SSH
     to the &xcat; server. This makes it easier to run commands required to
     finish the setup. With SSH disabled, you can alternatively run these
     commands using the &xcat; Web interface.
    </para>
    <para>
     To enable SSH set <envar>XCAT_MNadmin</envar> to a user name and
     <envar>XCAT_MN_pw</envar> to a password of your choice. The password
     should be changed when logging in via SSH for the first time.
    </para>
   </step>
   <step>
    <para>
     To save the <filename>DMSSICNF $COPY</filename> enter
     <literal>FILE</literal> followed by <keycap function="enter"/> on the
     XEDIT command line.
    </para>
   </step>
   <step>
    <para>
     Make the changes available by entering the following commands:
    </para>
    <screen>SERVICE CMS BUILD
PUT2PROD</screen>
   </step>
  </procedure>
  <para>
   Since ZHCP is integrated in the CMA, the stand-alone ZHCP server needs to be
   prevented from being IPLed. This is achieved by editing <filename>DMSSISRV
   NAMES</filename> and commenting the ZHCP entry. The result should look like
   the following:
   <remark condition="clarity">
    2016-09-26 - fs: Should a local copy be created first? On which disk does
    this file reside?
   </remark>
  </para>
  <screen>* Node server for xcat
 * :server.ZHCP
 * :type.XCAT
 * :subtype.NODE</screen>
  <para>
   To restart the &xcat; and ZHCP servers, proceed as follows:
  </para>
  <procedure>
   <title>Restarting &xcat; and ZHCP</title>
   <step>
    <para>
     Shut down and restart <remark>Correct terminology??</remark> VSMGUARD as
     an authorized user <remark>Correct terminology?? Which user?</remark>:
    </para>
    <screen>FORCE VSMGUARD
XAUTOLOG VSMGUARD</screen>
   </step>
   <step>
    <para>
     <remark>Correct terminology??</remark> Redirect the VSMGUARD log messages
     to the <systemitem class="username">xcat</systemitem> user ID, so you can
     check whether &xcat; and ZHCP have been restarted. The latter can take
     several minutes.
    </para>
    <screen>set secuser xcat *</screen>
   </step>
   <step>
    <para>
     Once the servers have been restarted, reset logging to the defaults by
     entering
    </para>
    <screen>set secuser xcat none</screen>
   </step>
   <step>
    <para>
     Check if the servers have been properly set up. Do so by browsing to the
     following Web page: <link
     xlink:href="https://XCAT_Host.XCAT_DOMAIN/xcat/"/>. <replaceable>XCAT_Host</replaceable>
     and <replaceable>XCAT_DOMAIN</replaceable> need to be replaced by the
     respective values from <filename>DMSSICNF CONF</filename>. If you have not
     set <replaceable>XCAT_Host</replaceable>, use the IP address provided with
     <envar>XCAT_MN_Addr</envar>, for
     example <link xlink:href="https://&wsIVip;/xcat/"/>.
    </para>
   </step>
   <step>
    <para>
     <remark condition="clarity">
      2016-09-26 - fs: Is this true? IBM docs claim credentials are admin/admin
      by default?
     </remark>
     Log in to the &xcat; GUI using the credentials provided with
     <envar>XCAT_MNadmin</envar> and <envar>XCAT_MN_pw</envar> in the
     <filename>DMSSICNF CONF</filename>. At this point it is recommended to
     change the administrator password as described in <link
     xlink:href="https://www.ibm.com/support/knowledgecenter/en/SSB27U_6.3.0/com.ibm.zvm.v630.dmse6/xcatgui.htm"/>.
    </para>
   </step>
  </procedure>
  <para>
   If you can access the &xcat; GUI and login successfully, &xcat; and ZHCP
   have been properly set up and the CMA has been started. To finish the setup
   on the &zseries; side, continue with <xref
   linkend="sec.deploy.zsystems.image"/>.
  </para>

  <tip>
   <title>Providing SSH Access for &rootuser; to the &xcat; Server</title>
   <para>

    <remark condition="clarity">
     2016-09-26 - fs: Clarify whether <envar>XCAT_MNadmin</envar> and
     <envar>XCAT_MN_pw</envar> are SSH credentials or used for the XCAT GUI
    </remark>
    Although optional, it is strongly recommended to enable connecting via SSH
    to the &xcat; server. This makes it easier to run commands required to
    finish the setup. With SSH disabled, you can alternatively run these
    commands using the &xcat; Web interface.
   </para>
   <para>
    <remark condition="clarity">
     2016-09-27 - fs: What about ssh-copy-id?
    </remark>
    Log in to the &xcat; GUI and navigate to the script panel as described in
    <link
      xlink:href="https://www.ibm.com/support/knowledgecenter/en/SSB27U_6.3.0/com.ibm.zvm.v630.dmse6/usesp.htm#usesp"/>. Enter
    the following command into the script box and <guimenu>Run</guimenu> it:
   </para>
   <screen>echo "<replaceable>SSH-KEY</replaceable>" > /root/.ssh/authorized_keys</screen>
   <para>
    Replace <replaceable>SSH-KEY</replaceable> with the public SSH key of the
    user that should be allowed to log in via SSH as &rootuser;.
   </para>
  </tip>
 </sect1>


 <sect1 xml:id="sec.deploy.zsystems.image">
  <title>Capture a &slsa; on &zseries; Image</title>
  <para>
   To start a &vmguest; an Linux on &zseries; operating system image is
   required. In order to create such an image, you need to set up a &slsa; 12
   SP1 system running in the same z/VM than the CMA. Once the system has been
   intalled and configured, you can shut it down and capture the image. In the
   following this Linux system used to capture the image from is referred to as
   the <quote>image capture system</quote>.
  </para>

  <sect2 xml:id="sec.deploy.zsystems.image.requirements">
   <title>Requirements for the Image Capture System</title>
   <para>
    The following requirements for the image capture system need to be met:
   </para>
   <itemizedlist>
    <listitem>
     <para>
      Use &slsa; 12 SP1 as an operating system. This system has been tested and
      is known to work. &slsa; 11 SP4 and RHEL 6.2 - 7.2 may also work but have
      not been tested by &suse;).
     </para>
    </listitem>
    <listitem>
     <para>
      Use a minidisk with ECKD for storage. FBA is currently not supported by
      &suse;. The minidisk must <emphasis>not</emphasis> be a full-pack disk
      and needs to be defined with the virtual address 1100.
      <remark condition="clarity">
       2016-10-12 - fs: Correct terminology?
      </remark>
     </para>
    </listitem>
    <listitem>
     <para>
      Network interfaces need to be configured with IPv4. Disabling IPv6 in the
      network settings is strongly recommended.
     </para>
    </listitem>
    <listitem>
     <para>
      The size of the root disk should not exceed 5 GB. It is also recommended
      to use a disk size with a full gigabyte value (for example 2GB or 3GB),
      since &ostack; disks are defined that way. See the <link
      xlink:href="http://ibmmainframes.com/references/disk.html">Mainframe Disk
      Capacity Table</link> for values that help to convert blocks or
      cyclinders to bytes.
     </para>
    </listitem>
    <listitem>
     <para>
      The root disk needs to have a single partition and the root file system
      must not be on a logical volume.
     </para>
    </listitem>
    <listitem>
     <para>
      The root file system needs to be formatted with Etx2, Etx3, Ext4, or
      XFS. Btrfs is currently not supported.
     </para>
    </listitem>
   </itemizedlist>
  </sect2>

  <sect2 xml:id="sec.deploy.zsystems.image.install">
   <title>Installing and Configuring the Image Capture System</title>
   <para>

   </para>
  </sect2>

 </sect1>


  <sect1 xml:id="app.deploy.zsystems.faq">
  <title>Frequently Asked Questions</title>
  <qandaset>
   <qandaentry xml:id="qa.zsystem.add.disks">
    <question>
     <para>
      How to provide the disks for the CMA? How to add disks at a later stage?
     </para>
    </question>
    <answer>
     <procedure>
      <step>
       <para>
        Format the disk(s) using <command>CPFMTXA</command>. Only
        CPFMTXA-formatted disks can be used by the CMA.
       </para>
      </step>
      <step>
       <para>
        ATTACH the disk to the system. Note that you must not add the disk to a
        directory manager disk group.
       </para>
      </step>
      <step>
       <para>
        Add the disk ID that was returned by the <command>CPFMTXA</command>
        command to the <envar>cmo_data_disk</envar> entry in the
        <filename>DMSSICMO COPY</filename> file as described in <xref
        linkend="pro.deploy.zsystems.dmssicmo"/>.
       </para>
      </step>
     </procedure>
     <para>
      All disks that are added this way will be added to a disk pool named
      XCAT1. New disks will be added to that pool every time the CMA logs on.
     </para>

     <tip>
      <title>Specifying a Value on Multiple Lines</title>
      <para>
       The maximum number of characters per line in <filename>DMSSICMO
       COPY</filename> is limited to 90 characters. In case you need to enter
       the disk IDs on multiple lines, start the value with a double quote on
       the first line and end it with a double quote on the last line. Each
       line that is continued, also needs to end with a space.
      </para>
      <screen>cmo_data_disk="<replaceable>volumeID1</replaceable> <replaceable>volumeID2</replaceable> <replaceable>volumeID3</replaceable> <replaceable>volumeID4</replaceable>
<replaceable>volumeID5</replaceable> <replaceable>volumeID6</replaceable>
<replaceable>volumeID7</replaceable>"</screen>
     </tip>
    </answer>
   </qandaentry>
   <qandaentry>
    <question>
     <para>
      How to attach disks to SYSTEM CONFIG?
     </para>
    </question>
    <answer>
     <para>
      TBD by bg
     </para>
    </answer>
   </qandaentry>
   <qandaentry>
    <question>
     <para>
      How to give &xcat; appropriate permissions to access SMAPI?
     </para>
    </question>
    <answer>
     <para>
      TBD by bg
     </para>
    </answer>
   </qandaentry>
   <qandaentry>
    <question>
     <para>
      How to create or modify a disk pool for instances for ECKD?
     </para>
    </question>
    <answer>
     <para>
      TBD by bg
     </para>
    </answer>
   </qandaentry>
      <qandaentry>
    <question>
     <para>
      How to create or modify a disk pool for instances for FBA?
     </para>
    </question>
    <answer>
     <para>
      TBD by bg
     </para>
    </answer>
   </qandaentry>
  </qandaset>
 </sect1>
</appendix>
