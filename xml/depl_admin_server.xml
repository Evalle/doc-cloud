<?xml version="1.0" encoding="utf-8"?>
<?xml-stylesheet
 href="urn:x-daps:xslt:profiling:novdoc-profile.xsl" 
 type="text/xml"
 title="Profiling step"?>
<!DOCTYPE chapter PUBLIC "-//Novell//DTD NovDoc XML V1.0//EN" "novdocx.dtd"
[
  <!ENTITY % NOVDOC.DEACTIVATE.IDREF "IGNORE">
  <!ENTITY % entities SYSTEM "entity-decl.ent">
  %entities;
]>
<chapter id="cha.depl.admin_server">
 <title>Setting Up the &cloud; &admserv;</title>
 <abstract>
  <para>
   In this chapter you will learn how to install and set up the &admserv; from
   bare metal. As a result, the &admserv; will be ready to deploy ostack;
   nodes and services. It will run on &sls; 11 SP2 plus add-on products &smtool;
   (also referred to as &smt;, optional) and &cloud;.
  </para>
 </abstract>
 
 <sect1 id="sec.depl.admin_server.install">
  <title>Installation</title>
  <para>
   Installing the &admserv; involves the following steps:
  </para>
  <orderedlist>
   <listitem>
    <para>
     <!-- Operating System Installation -->
     <xref linkend="sec.depl.admin_server.install.os" xrefstyle="select:title nopage"/>
    </para>
    <orderedlist>
     <listitem>
      <para>
       <!-- Add-On Products Selection -->
       <xref linkend="sec.depl.admin_server.install.os.add_on" xrefstyle="select:title nopage"/>
      </para>
     </listitem>
     <listitem>
      <para>
       <!-- Partitioning -->
       <xref linkend="sec.depl.admin_server.install.os.partition" xrefstyle="select:title nopage"/>
      </para>
     </listitem>
     <listitem>
      <para>
       <!-- Software Selection -->
       <xref linkend="sec.depl.admin_server.install.os.software" xrefstyle="select:title nopage"/>
      </para>
     </listitem>
     <listitem>
      <para>
       <!-- Product registration -->
       <xref linkend="sec.depl.admin_server.install.os.software" xrefstyle="select:title nopage"/>
      </para>
     </listitem>
     <listitem>
      <para>
       <!-- CA configuration -->
       <xref linkend="sec.depl.admin_server.install.os.ca" xrefstyle="select:title nopage"/>
      </para>
     </listitem>
     <listitem>
      <para>
       <!-- Basic network configuration -->
       <xref linkend="sec.depl.admin_server.install.os.network" xrefstyle="select:title nopage"/>
      </para>
     </listitem>
     <listitem>
      <para>
       <!-- SMT Configuration -->
       <xref linkend="sec.depl.admin_server.install.os.smt" xrefstyle="select:title nopage"/>
      </para>
     </listitem>
     <listitem>
      <para>
       <!-- Crowbar configuration -->
       <xref linkend="sec.depl.admin_server.install.os.crowbar" xrefstyle="select:title nopage"/>
      </para>
     </listitem>
    </orderedlist>
   </listitem>
   <listitem>
    <para>
     <!-- SMT repository setup -->
     <xref linkend="sec.depl.admin_server.install.smt_repos" xrefstyle="select:title nopage"/>
    </para>
   </listitem>
   <listitem>
    <para>
     <!-- Local repository setup -->
     <xref linkend="sec.depl.admin_server.install.local_repos" xrefstyle="select:title nopage"/>
    </para>
   </listitem>
   <listitem>
    <para>
     <!-- Run install -chef-suse.sh -->
     <xref linkend="sec.depl.admin_server.install.cloud_setup" xrefstyle="select:title nopage"/>
    </para>
   </listitem>
  </orderedlist>
  <sect2 id="sec.depl.admin_server.install.os">
   <title>Operating System Installation</title>
   <para>
    Starting with a bare metal server, the first thing you need to do when
    deploying &cloud; is to install &sls; on the machine that should serve as
    the &admserv;. 
   </para>
   <para>
    Start the installation by booting from the &sls; 11 SP2 installation
    medium. For an installation overview refer to the &sls; &instquick;;
    detailed installation instructions are available in the &sls;
    <citetitle>Deployment Guide</citetitle>. Both documents are available at
    <ulink url="http://www.suse.com/documentation/sles11/"/>. The following
    will only cover issues that differ from the default installation process.
   </para>
   <para>
    Installing the Add-On products &cloud; and &smt; during the &sls;
    installation is recommended. Make sure to be able to access the
    installation media (DVD or iso image). Alternatively you may do the Add-On
    product installation after the &sls; installation.
   </para>
   <para>
    If you have access to an &smt; server within your organization, it is
    recommended using it for &cloud;, too. In this case skip the &smt; Add-On
    product installation. If you have no access to an &smt; server, installing
    it is required.
   </para>
   <sect3 id="sec.depl.admin_server.install.os.add_on">
    <title>Add-On Product Selection</title>
    <para>
     Click <guimenu>Include Add-On products from Separate Media</guimenu> on
     the <guimenu>Installation Mode</guimenu> screen. The Add-On product
     installation dialog will show up after proceeding with
     <guimenu>Next</guimenu>. Skip the network installation dialog if you have
     direct access to the installation media (e.g. via DVD or USB stick).  Add
     the &cloud; and &smt; products and proceed with the installation. Consult
     the &sls; <citetitle>Deployment Guide</citetitle> at <ulink
     url="http://www.suse.com/documentation/sles11/book_sle_deployment/data/sec_i_yast2_inst_mode.html"/>
     for detailed instructions.
    </para>
   </sect3>
   <sect3 id="sec.depl.admin_server.install.os.partition">
    <title>Partitioning</title>
    <para>
     &cloud; has no special requirements in regards of partitioning. However,
     it is recommended to create a separate partition or volume for
     <filename>/srv</filename>. This partition will host all update
     repositories mirrored by &smt; as well as the complete data from the
     &sls; and &cloud; installation media for the node deployment. A size of
     at least 25 GB is required. Help on using the partitioning tool is
     available at <ulink
     url="http://www.suse.com/documentation/sles11/book_sle_deployment/data/sec_yast2_i_y2_part_expert.html"/>.
    </para>
   </sect3>

   <sect3 id="sec.depl.admin_server.install.os.software">
    <title>Software selection</title>
    <para>
     Installing a fairly minimal base system is sufficient to set up the
     &admserv;. The following patterns are the minimum requirement:
    </para>
    <itemizedlist>
     <listitem>
      <para>
       <guimenu>Base System</guimenu>
      </para>
     </listitem>
     <listitem>
      <para>
       <guimenu>Minimal System (Appliances)</guimenu>
      </para>
     </listitem>
     <listitem>
      <para>
       <guimenu>Subscription Management Tool</guimenu> (SMT)
      </para>
     </listitem>
     <listitem>
      <para>
       <guimenu>SUSE Cloud Admin Node</guimenu>
      </para>
     </listitem>
     <listitem>
      <para>
       <guimenu>Web and LAMP Sever</guimenu>
      </para>
     </listitem>
    </itemizedlist>
   </sect3>
   <sect3 id="sec.depl.admin_server.install.os.registration">
    <title>Product Registration</title>
    <para>
     If you have installed the &smt; Add-On product, you must register your
     &sls; version at the &ncc; now, otherwise you will not be able to
     configure the &smt; server. You have received a &sls; registration key
     with the &cloud; &admserv; subscription. See <ulink
     url="http://www.suse.com/documentation/sles11/book_sle_deployment/data/sec_i_yast2_conf.html"/>
     for details on the &ncc; registration.
    </para>
   </sect3>
   
   <sect3 id="sec.depl.admin_server.install.os.ca">
    <title>CA Setup</title>
    <para>
     <remark condition="clarity">
      2012-08-02 - fs: How to use an external CA?
     </remark>
     &ostack; needs access to a certification authority (CA) for project
     VPNs and encrypted images. If you can access an existing CA within your
     organization, you can use it as described in FIXME. If not, you need to
     set up a CA on the &admserv;. See <ulink
     url="http://www.suse.com/documentation/sles11/book_security/data/cha_security_yast_ca.html"/>
     for more information.
    </para>
   </sect3>
   
   <sect3 id="sec.depl.admin_server.install.os.network">
    <title>Basic Network Configuration</title>
    <para>
     
     <remark condition="clarity">
      2012-08-02 - fs: Which firewall settings should be applied to the
      interfaces?
     </remark>
     
     All network interfaces on the &admserv; need to be configured during the
     installation. Since &crow; does not support DHCP, you need to assign
     static IP addresses for each interface. The default setup supports one
     network interface (<systemitem class="resource">eth0</systemitem> ) with
     the IP address <systemitem
     class="etheraddress">192.168.124.10/24</systemitem>. Using a custom IP
     address or more than one network interfaces requires to adjust the
     crowbar configuration in a later step as described in FIXME.
    </para>
    <para>
     If you realize the &cloud; network example, addresses need to be
     assigned as follows: FIXME 
    </para>
    <para>
     You also need to assign a hostname and a full qualified domain name
     (FQDN) such as <replaceable>cloud-admin.&exampledomain;</replaceable> to
     <systemitem class="resource">eth0</systemitem>.
    </para>
    
    <warning>
     <title>Changing the &admserv; Hostname</title>
     <para>
      It is <emphasis>not</emphasis> possible to change the &admserv; hostname
      once &cloud; has been set up. 
     </para>
    </warning>
    
   </sect3>
   
   <sect3 id="sec.depl.admin_server.install.os.smt">
    <title>&smt; Configuration</title>
    <para>
     
     <remark condition="clarity">
      2012-08-02 - fs: Open port in firewall?
     </remark>
     
     Configuring the &smt; server requires you to have your mirroring
     credentials and your registration e-mail address at hand. Log in to the
     &ncc; at <ulink url="http://www.novell.com/center/"/>. Get the mirror
     credentials by going to <menuchoice> <guimenu>My Products</guimenu>
     <guimenu>Mirror Credentials</guimenu> </menuchoice> in the left
     navigation. Your registration e-mail address can be obtained from
     <menuchoice> <guimenu>My Profile</guimenu> <guimenu>Login
     Profile</guimenu> </menuchoice>. Enter this data at the <guimenu>SMT
     Configuration Wizard Step 1/2</guimenu> screen at the fields
     <guimenu>User</guimenu>, <guimenu>Password</guimenu>, and <guimenu>NCC
     E-mail Used for Registration</guimenu> and accept the pre-filled defaults
     for the other input fields.  Make sure to <guimenu>Test</guimenu> the
     credentials. 
    </para>
    <para>
     In step two of the &smt; configuration you need to enter database
     passwords and specify an e-mail address for getting reports. Refer to
     <ulink url="http://www.suse.com/documentation/smt11/"/> for the complete
     <citetitle>SMT for SUSE Linux Enterprise 11 Guide</citetitle>.
    </para>
   </sect3>
   
   <sect3 id="sec.depl.admin_server.install.os.crowbar">
    <title>&crow; Setup</title>
    <para>
     FIXME - to be described once we have the network proposal 
    </para>
   </sect3>
  </sect2>
  
  <sect2 id="sec.depl.admin_server.install.smt_repos">
   <title>Setting up the &smt; Repositories</title>
   <para>
    <remark condition="clarity">
     2012-08-02 - fs: What about mirroring Cloud and SMT update repositories?
    </remark>
    During the installation the &smt; server was set up to be able to
    communicate with the &ncc;. In this step we will add and mirror the update
    repositories for &sls;. They will serve as the update source for the
    &ostack; nodes. Run the following commands as user &rootuser;: 
   </para>
   
   <screen>for REPO in 1-Pool 1-Update 2-Core 2-Update; do
>  smt repos SLES11-SP$REPO sle-11-x86_64 -e
> done
smt mirror -L /var/log/smt/smt-mirror.log</screen>
   <para>
    The <command>smt mirror</command> command will download approximately 13
    GB of patches. This process may last up to several hours. A log file is
    written to <filename>/var/log/smt/smt-mirror.log</filename>.
   </para>
  </sect2>

  <sect2 id="sec.depl.admin_server.install.local_repos">
   <title>Setting Up Local Repositories</title>
   <para>
    
    <remark condition="clarity">
     2012-08-02 - fs: What about Cloud and SMT update repositories?
    </remark>
    
    In order to deploy the &ostack; nodes and to provide update repositories for
    them, repositories need to be available locally at
    <filename>/srv/tftpboot</filename>. 
   </para>
   <procedure>
    <step>
     <para>
      Make the  contents of the &sls; installation medium available at
      <filename>/srv/tftpboot/suse-11.2/install/</filename>. Either mount the
      medium or copy it's contents. Do not link it, as this may cause trouble
      when PXE-booting clients.
     </para>
     <para>
      If copying, it is recommended to use <command>rsync</command>. If the
      installation data is located on a removable device, make sure to mount
      it first:
     </para>
     <screen>mount /dev/dvd /mnt
rsync -avP /mnt/ /srv/tftpboot/suse-11.2/install/
umount /mnt</screen>
     <para>
      If the installation data is provided by a remote machine, log in to that
      machine and push the data to the &admserv; (which has the IP address
      <systemitem class="etheraddress">192.168.124.10</systemitem> in the
      following example):
     </para>
     <screen>rsync -avPz <replaceable>/data/sles11sp2/</replaceable> <replaceable>192.168.124.10</replaceable>:/srv/tftpboot/suse-11.2/install/</screen>
    </step>
    <step>
     <para>
      Make the  contents of the &cloud; installation medium available at
      <filename>/srv/tftpboot/repos/Cloud/</filename> using one of the
      techniques described in the previous step.
     </para>
    </step>
    <step>
     <para>
      It is recommended to use the two directories created in the previous
      steps as the installation source for &sls; and &cloud;. In order to do
      so, remove the existing two repositories and add them again with the new
      location (the local directories at <filename>/srv/tftpboot/</filename>.
     </para>
    </step>
    <step>
     <para>
      Link the &smt; update repositories (in this case links can be used,
      because these repositories are not used for PXE-booting). Since they are
      available locally there is no need to use remote repositories for
      updating &admserv; itself, therefore add these repositories to
      <systemitem class="library">libzypp</systemitem>, too:
     </para>
     <screen>for REPO in 1-Pool 1-Update 2-Core 2-Update; do
> ln -s /srv/www/htdocs/repo/\$RCE/SLES11-SP$REPO/sle-11-x86_64 \
/srv/tftpboot/repos/SLES11-SP$REPO
> zypper ar /srv/www/htdocs/repo/\$RCE/SLES11-SP$REPO/sle-11-x86_64 \
SLES11-SP$REPO
> done</screen>
    </step>
    <step>
     <para>
      
      <remark condition="clarity">
       2012-08-02 - fs: is it really wise to disable _all_ repos from
       nu_novell_com? There are repositories which have not been mirrored by
       smt...
      </remark>
      
      Now all repositories needed to update all nodes in the cloud (including
      the &admserv; as well) and to deploy the &ostack; nodes are available as
      local repositories. Therefore remote repositories from the &ncc; can be
      disabled by running the following command:
     </para>
     <screen>zypper ms -d -R nu_novell_com</screen>
     <para>
      Optionally you can also disable automatic refreshing for these repositories:
     </para>
     <screen>zypper mr -d -R `zypper lr -s | grep "nu_novell_com" | cut -c 1-3`</screen>
    </step>
    <step>
     <para>
      The local repository setup is completed. If you have skipped the online
      update during installation, you need to update the system now, before
      setting up the cloud:
     </para>
     <screen>zypper patch</screen>
    </step>
   </procedure>
  </sect2>

  <sect2 id="sec.depl.admin_server.install.cloud_setup">
   <title>Setting up &cloud;</title>
   <para>
    Now everything is in place to finally configure the &admserv;. This is
    done by running the script
    <filename>/opt/dell/bin/install-chef-suse.sh</filename>. This command will
    install and configure &chef;, and use it to complete the installation of
    &crow; and all required &barcl;. It will take several minutes to complete.
   </para>
   <para>
    It is strongly recommended to run this script inside of
    <command>screen</command>. During the run of this script the network will
    be reconfigured and such may result in interrupting the script when being
    run from a network connection. Using <command>screen</command> will
    continue running the script in a session you can reconnect to.  On the one
    hand it provides and easy way of logging the scrip's output (with the
    <option>-L</option> option), making it easier to debug errors, if
    occurring. the output will be logged to
    <filename>./screenlog.0</filename>.
   </para>
   <screen>screen -L /opt/dell/bin/install-chef-suse.sh</screen>
  </sect2>
  
 </sect1>
 

 
<!-- Add-On Products:
  - SMT
  - Cloud

Software selection:
  Install proposal -> Software -> SUSE Cloud Admin Node

Recommended Partitioning:
  - srv on own partition with minimum of 30GB

Register Product !!!

Fixed IP Address: 192.168.124.10/24   -> Routing/DNS ?
No network manager
Firewall settings???

Online update! -> may skip and do it later if SMT

Set up CA!

Network User Authentication??


SMT Setup:
  Reg Server Url, Download Server Url
    -> do not change unless??
  www.novell.com/center/ -> My Products -> Mirror Credentials
  User: 
  Password:

  after data is entered SMT runs a synchronization check -> takes up to a few minutes


Crowbar configuration:
  password for crowbar admin (User crowbar):
    default: crowbar/crowbar

Release Notes: Tabs for SLES, SMT, Cloud



Installation finished:
- smt repo commands, smt mirror
- symlink channels
- copy SLES and Cloud repos
- disable remote repos:
  zypper ms -d -R nu_novell_com
  zypper mr -d -R $(zypper lr -s | grep "nu_novell_com" | cut -c 1-3)
- add local repos
  for REP in 1-Update 1-Pool 2-Update 2-Core; do
    zypper ar /srv/www/htdocs/repo/\$RCE/SLES11-SP$REP/sle-11-x86_64 SLES11-SP$REP
  done
- optional: modify repos that have been copied to /srv/tftpboot (SLES, Cloud)
  -delete and add it again (only way):
   zypper rr <repo>
   zypper ar /srv/tftpboot/suse-11.2/install "SLES11-SP2"
   zypper ar /srv/tftpboot/repos/Cloud "SUSE Cloud"



Questions:
* How to use external DNS?
* How to use external SMT?
* How to use external CA?

* Automatic network setup vs.
  https://github.com/dellcloudedge/crowbar/wiki/Crowbar-Openstack-Networking-Visio
   -> routing.

* SMT repos for SMT/Cloud?
* Delivery of updates to nodes (incl. admin) and VM instances?
  - Delivery of updates for other OS than SUSE?

-->
</chapter>
