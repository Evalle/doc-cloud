<?xml version="1.0" encoding="utf-8"?>
<?xml-stylesheet
 href="urn:x-daps:xslt:profiling:novdoc-profile.xsl" 
 type="text/xml"
 title="Profiling step"?>
<!DOCTYPE appendix PUBLIC "-//Novell//DTD NovDoc XML V1.0//EN" "novdocx.dtd"
[
  <!ENTITY % NOVDOC.DEACTIVATE.IDREF "IGNORE">
  <!ENTITY % entities SYSTEM "entity-decl.ent">
  %entities;
]>
<appendix id="app.deploy.network_json">
 <title>The Network Barclamp Template File</title>
 <para>
  Complex network setups require to manually edit the network barclamp
  template file at
  <filename>/opt/dell/chef/data_bags/crowbar/bc-template-network.json</filename>. this
  section explains the file in detail. Settings in this file are applied to
  all nodes in &cloud;. 
 </para>
 <sect1 id="sec.deploy.network_json.FIXME">
  <title>FIXME</title>
  <screen>
   Main parts:
    * global attributes
    * deployment
    * attributes
      - conduit_map
        o team
	o dual
	o single
      - mode
        o networks
      - interface map
  </screen>

  <note>
   <title>Order of Elements</title>
   <para>
    The order in which the entries in the
    <filename>bc-template-network.json</filename> appear, may differ from the
    one listed above. Use your editor's search function to find certain entries.
   </para>
  </note>

  <sect2 id="sec.deploy.network_json.global">
   <title>Global Attributes</title>
   <para>
    The following global attributes exist:
   </para>
   <screen>        "id" : "bc-template-network",<co id="global.id"/>
        "description" : "Instantiates network interfaces on the crowbar managed systems. Also manages the address pool",<co id="global.description"/>
        "start_up_delay" : 30,<co id="global.startup"/>
         "mode": "single",<co id="global.mode"/>
         "teaming" : { "mode" : 6 },<co id="global.bonding"/></screen>
   <calloutlist>
    <callout arearefs="global.id">
     <para>
      Identifier. Do not change.
     </para>
    </callout>
    <callout arearefs="global.description">
     <para>
      Description displayed in the WebUI. Do not change.
     </para>
    </callout>
    <callout arearefs="global.startup">
     <para>
      Time (in seconds) the &chef;-client waits before running into a time-out
      for the network interfaces to become online.
     </para>
    </callout>
    <callout arearefs="global.mode">
     <para>
      Network mode to be used. The mode needs to be defined in the network
      conduits part of this file (see <xref
      linkend="sec.deploy.network_json.conduits"/>). The modes
      <literal>single</literal>, <literal>dual</literal> and
      <literal>team</literal> are already pre-defined. See <xref
      linkend="sec.depl.req.network.modes"/> for details.
     </para>
    </callout>
    <callout arearefs="global.bonding">
     <para>
      Default bonding mode to be used. See <ulink
      url="https://www.kernel.org/doc/Documentation/networking/bonding.txt"/>
      for a list of available modes.
     </para>
     <warning>
      <title>Bonding Mode 6 (balance-alb) not supported</title>
      <para>
       Adaptive load balancing (balance-alb or 6) is not supported because of
       problems with bridges and openvswitch).
      </para>
     </warning>
    </callout>
   </calloutlist>
  </sect2>


  <sect2 id="sec.deploy.network_json.interface_map">
   <title>Interface Map</title>
   <para>
    Physical network interfaces are used by the order they appear under
    <filename>/sys/class/net/</filename> by default. The first interface
    listed is used to boot the node. In case you would like to apply a custom
    order, you need to create an interface map. Interface maps are created for
    specific hardware configurations and are applied to all machines matching
    this configuration. 
   </para>
   <screen>            {
               "pattern" : "SERVER AR2000"<co id="interface.pattern"/>,
               "bus_order" : [<co id="interface.bus"/>
	          "0000:00:1c.0/0000:09:00.2",
		  "0000:00:1c.0/0000:09:00.0",
		  "0000:00:1c.0/0000:09:00.1",
		  "0000:00:1c.0/0000:09:00.3"
               ]
            } </screen>
   <calloutlist>
    <callout arearefs="interface.pattern">
     <para>
      Hardware specific identifier. This identifier can be obtained by running
      the following command on the machine you want to identify (adding quotes
      to the dmidecode output ensures that leading and trailing spaces are not
      getting lost):
     </para>
     <screen>echo \"$(dmidecode -s system-product-name)\"</screen>
    </callout>
    <callout arearefs="interface.bus">
     <para>
      Bus IDs of the interfaces. The order in which they are listed here
      defines the order in which &chef; addresses the interfaces. The IDs can
      be obtained by listing the contents of
      <filename>/sys/class/net/</filename>.
     </para>
     <screen>~ # ls -lgG /sys/class/net/ | grep eth
lrwxrwxrwx 1 0 Jun 19 08:43 eth0 -> ../../devices/pci0000:00/0000:00:1c.0/0000:09:00.0/net/eth0
lrwxrwxrwx 1 0 Jun 19 08:43 eth1 -> ../../devices/pci0000:00/0000:00:1c.0/0000:09:00.1/net/eth1
lrwxrwxrwx 1 0 Jun 19 08:43 eth2 -> ../../devices/pci0000:00/0000:00:1c.0/0000:09:00.2/net/eth2
lrwxrwxrwx 1 0 Jun 19 08:43 eth3 -> ../../devices/pci0000:00/0000:00:1c.0/0000:09:00.3/net/eth3
</screen>
    </callout>
   </calloutlist>
  </sect2>
  

  <sect2 id="sec.deploy.network_json.conduits">
   <title>Network Conduits</title>
   <para>
    FIXME
   </para>
   <screen>         "conduit_map" : [
         ...
            {
               "pattern" : "dual/.*/.*",<co id="conduit.pattern"/>
               "conduit_list" : {
                  "intf0"<co id="conduit.name"/>
                     "if_list" : ["?1g1"]<co id="conduit.interface"/>
                  },
                  "intf1" : {
                     "if_list" : ["?1g2"]
                  },
                  "intf2" : {
                     "if_list" : ["?1g1"]
                  }
               }
            },
         ...
         ],</screen>
   <calloutlist>
    <callout arearefs="conduit.pattern">
     <para>
      Conduit lists are specified for each of the three networking modes
      (<literal>single</literal>, <literal>dual</literal> and
      <literal>team</literal>). This line specifies the mode.
     </para>
    </callout>
    <callout arearefs="conduit.name">
     <para>
      Network interface identifier. This identifier must be unique and will
      also be referenced in the <guimenu>Network</guimenu>. If you   
     </para>
    </callout>
    
   </calloutlist>
  </sect2>
  

 </sect1>
</appendix>
