<?xml version="1.0" encoding="utf-8"?>
<?xml-stylesheet
href="urn:x-daps:xslt:profiling:novdoc-profile.xsl" 
type="text/xml"
title="Profiling step"?>
<!DOCTYPE chapter PUBLIC "-//Novell//DTD NovDoc XML V1.0//EN" "novdocx.dtd"
[
<!ENTITY % NOVDOC.DEACTIVATE.IDREF "IGNORE">
<!ENTITY % entities SYSTEM "entity-decl.ent">
%entities;
]>
<chapter id="cha.depl.inst">
 <title>Installing and Configuring the &admserv;</title>
 <abstract>
  <para>
   Deploying and installing &productname; is a multi-step process, starting by
   deploying a basic &sls; installation and the &productname; add-on product
   to the &admserv;. Now the product and update repositories need to be set up
   and the &cloud; network needs to be configured. Next the &admserv; setup
   will be finished. Once the &admserv; is ready, you can start deploying and
   configuring the &ostack; nodes. The complete node deployment is done
   automatically via &crow; and &chef; from the &admserv;. All you need
   to do is to PXE boot the nodes and to deploy the &ostack; services
   to them.
  </para>
 </abstract>  
 <procedure>
  <title>High Level Overview of the &cloud; Installation</title>
  <step>
   <para>
    Install &sls; 11 SP2 on the &admserv; with the Add-On products
    &smtool; (optional) and &cloud;. See below.
   </para>
  </step>
  <step>
   <para>
    Once the &admserv; is set up, PXE boot all nodes onto which the
    &ostack; components should be deployed and allocate them in the &crow; Web
    interface to start the automatic &sls; installation. See <xref
    linkend="sec.depl.inst.nodes"/>.
   </para>
  </step>
  <step>
   <para>
    Configure and deploy the &ostack; services via the &crow; Web
    interface or command line tools. See <xref linkend="cha.depl.ostack"/>.
   </para>
  </step>
  <step>
   <para>
    When all &ostack; services are up and running, &cloud; is ready. The
    cloud admin can now upload images to enable users to start deploying
    &vmguest;s. See <xref linkend="book.cloud.admin"/>.
   </para>
  </step>
 </procedure>
 <para>
  In this chapter you will learn how to install and set up the &admserv; from
  bare metal. As a result, the &admserv; will be ready to deploy &ostack;
  nodes and services. It will run on &sls; 11 SP2 and will include the add-on
  products &productname; and &smt; (optional). Installing the &admserv;
  involves the following basic steps:
 </para>
 <sect1 id="sec.depl.inst.admserv.os">
  <title>Operating System Installation</title>
  <para>
   Start the installation by booting from the &sls; 11 SP2 installation
   medium.
  </para>
  <note>
   <title>Differences from the Default Installation Process</title>
   <para>
    For an overview of a default &sls; installation, refer to the &sls;
    &instquick;. Detailed installation instructions are available in the
    &sls; <citetitle>Deployment Guide</citetitle>. Both documents are
    available at <ulink url="http://www.suse.com/documentation/sles11/"/>.
   </para>
   <para>
    The following sections will only cover the differences from the default
    installation process.
   </para>
  </note>
  <sect2 id="sec.depl.inst.admserv.os.add_on">
   <title>Add-On Product Selection</title>
   <para>
    Installing the Add-On products &cloud; and &smt; (optional) during the
    &sls; installation is recommended. Make sure to be able to access the
    installation media (DVD or iso image). Alternatively, install the add-on
    products after the &sls; installation.
   </para>
   <para>
    If you have access to remote update repositories for &sls; and &cloud;
    from the cloud's admin network, you may want to skip the &smt; Add-On
    product installation. Please refer to <xref linkend="sec.depl.req.repos"/>
    for details.
   </para>
   <para>
    On the <guimenu>Installation Mode</guimenu> screen, click
    <guimenu>Include Add-On products from Separate Media</guimenu>. Proceed
    with <guimenu>Next</guimenu> to the Add-On product installation dialog.
    I you have direct access to the installation media (for example, via DVD
    or USB stick), skip the network installation dialog. Otherwise configure
    the network as described in <xref
    linkend="sec.depl.inst.admserv.os.network"/>.  Add &cloud; and
    &smt; (optional) as add-on products and proceed with the
    installation. Consult the &sls; <citetitle>Deployment Guide</citetitle>
    at <ulink
    url="http://www.suse.com/documentation/sles11/book_sle_deployment/data/sec_i_yast2_inst_mode.html"/>
    for detailed instructions.
   </para>
  </sect2>
  <sect2 id="sec.depl.inst.admserv.os.partition">
   <title>Partitioning</title>
   <para>
    Currently, &crow; requires <filename>/opt</filename> to be writable.
    Apart from that, &cloud; has no special requirements in regards of
    partitioning. However, it is recommended to create a separate partition
    or volume for <filename>/srv</filename>. /srv will host all update and
    product repositories for &sls; and &cloud;. A size of at least 25 GB is
    required. Help on using the partitioning tool is available at <ulink
    url="http://www.suse.com/documentation/sles11/book_sle_deployment/data/sec_yast2_i_y2_part_expert.html"/>.
   </para>
  </sect2>

  <sect2 id="sec.depl.inst.admserv.os.software">
   <title>Software selection</title>
   <para>
    Installing a minimal base system is sufficient to set up the
    &admserv;. The following patterns are the minimum requirement:
   </para>
   <itemizedlist>
    <listitem>
     <para>
      <guimenu>Base System</guimenu>
     </para>
    </listitem>
    <listitem>
     <para>
      <guimenu>Minimal System (Appliances)</guimenu>
     </para>
    </listitem>
    <listitem>
     <para>
      <guimenu>Subscription Management Tool</guimenu> (optional)
     </para>
    </listitem>
    <listitem>
     <para>
      <guimenu>SUSE Cloud Admin Node</guimenu>
     </para>
    </listitem>
    <listitem>
     <para>
      <guimenu>Web and LAMP Server</guimenu> (only needed when installing 
      &smt;)
     </para>
    </listitem>
   </itemizedlist>
  </sect2>
  <sect2 id="sec.depl.inst.admserv.os.registration">
   <title>Product Registration</title>
   <para>
    Although you can also register your products at any time after the
    installation, it is recommended to register &sls; and &productname; now,
    because it will give you immediate access to the update channels.  If you
    have installed the &smt; Add-On product, you <emphasis>must</emphasis>
    register your &sls; version at the &ncc; <emphasis>now</emphasis>,
    otherwise you will not be able to configure the &smt; server.  You have
    received registration keys with the &cloud; &admserv; subscription. See
    <ulink
      url="http://www.suse.com/documentation/sles11/book_sle_deployment/data/sec_i_yast2_conf.html"/>
    for details on the &ncc; registration.
   </para>
   
   <note>
    <title>&suse; Login Required</title>
    <para>
     In order to register a product, you need to have a &suse;/&novell;
     login. If you do not have such a login, create it at <ulink
     url="http://www.suse.com/login"/>. 
    </para>
   </note>
  </sect2>

  <sect2 id="sec.depl.inst.admserv.os.online_update">
   <title>Online Update</title>
   <para>
    A successful product registration will add update repositories for &sls;
    and all add-on products. After having successfully registered you will be
    asked to perform an online update, which will update the system and the
    add-on products. It is strongly recommended to perform the update at this
    point in time. If you choose to skip the update now, you must perform it
    later, before running the Cloud installation script.
   </para>
  </sect2>
  
  <sect2 id="sec.depl.inst.admserv.os.ca">
   <title>CA Setup</title>
   <para>
    In case you have installed &smt; you need to provide a certification
    authority (CA). If you already have a CA certificate in your organization,
    import it.  Otherwise generate all certificates in the &admserv; itself by
    accepting the &yast; proposal. See <ulink
    url="http://www.suse.com/documentation/sles11/book_security/data/cha_security_yast_ca.html"/>
    for more information.
   </para>
   <para>
    If &smt; is not installed, click on the <guimenu>CA Management</guimenu>
    link and choose to not set up a CA.
   </para>
  </sect2>

  <sect2 id="sec.depl.inst.admserv.os.network">
   <title>Basic Network Configuration</title>
   <para>
    Only the first interface (<systemitem class="resource">eth0</systemitem>)
    on the &admserv; needs to be configured during the installation. Other
    interfaces will be automatically configured by the cloud installation
    script.
   </para>
   <para>
    <systemitem class="resource">eth0</systemitem> needs to be given a fixed
    IP address from the admin network&mdash;when sticking with the default
    network addresses this would be <systemitem
    class="etheraddress">192.168.124.10</systemitem>. The address you need to
    enter for the <guimenu>Default Gateway</guimenu> depends on whether you
    have provided an external gateway for the admin network (use the address
    of that gateway) or not (use <replaceable>xxx.xxx.xxx</replaceable>.1,
    e.g <systemitem class="etheraddress">192.168.124.1</systemitem>). Using a
    custom IP address or more than one network interfaces requires to adjust
    the &crow; configuration in a later step as described in <xref
    linkend="sec.depl.inst.admserv.os.crowbar"/>.
   </para>
   <para>
    If you allow to access the admin network from another network (via
    gateway or bastion network), you can also add one or more
    name servers. The &admserv;'s name server will automatically be configured
    by the cloud installation script to forward requests for non-local
    records to those server(s).
   </para>
   <para>
    You also need to assign a hostname and a full qualified domain name
    (FQDN) such as <replaceable>admin.cloud.&exampledomain;</replaceable> to
    <systemitem class="resource">eth0</systemitem>.
   </para>
   <para>
    Last, the firewall need to be disabled for all interfaces.
   </para>
   <important>
    <title>&admserv; Domain Name and Hostname</title>
    <para>
     Setting up the &cloud; will also install a DNS server for all nodes in
     the cloud. The domainname you specify for the &admserv; will be used for
     the DNS zone. It is recommended to use a sub-domain such as
     <replaceable>cloud.&exampledomain;</replaceable>.
    </para>
    <para>
     The hostname and the FQDN need to be resolvable with <command>hostname
     <option>-f</option> </command>. Double-check whether
     <filename>/etc/hosts</filename> contains an appropriate entry for the
     &admserv;. It should look like the following:
    </para>
    <screen>191.168.124.10 admin.cloud.&exampledomain; admin</screen>
    <para>
     It is <emphasis>not</emphasis> possible to change the &admserv; hostname
     or the FQDN once the cloud installation script has been.
    </para>
   </important>
  </sect2>

  <sect2 id="sec.depl.inst.admserv.os.smt">
   <title>&smt; Configuration (optional)</title>
   <para>
    Skip this step if you do not have installed the &smt; add-on product. In
    case you have installed it, you will be asked to configure
    it. Configuring the &smt; server requires you to have your mirroring
    credentials and your registration e-mail address at hand. To access them,
    log in to the &ncc; at <ulink url="http://www.novell.com/center/"/>. Get
    the mirror credentials by selecting <menuchoice> <guimenu>My
    Products</guimenu>
    <guimenu>Mirror Credentials</guimenu> </menuchoice> in the left
    navigation. Obtain your registration e-mail address from <menuchoice>
    <guimenu>My Profile</guimenu> <guimenu>Login Profile</guimenu>
    </menuchoice>.
   </para>
   <para>
    Enter this data at the <guimenu>SMT Configuration Wizard Step
    1/2</guimenu> into the fields <guimenu>User</guimenu>,
    <guimenu>Password</guimenu>, and <guimenu>NCC E-mail Used for
    Registration</guimenu>. Accept the pre-filled defaults for the other
    input fields.  Make sure to <guimenu>Test</guimenu> the credentials.
   </para>
   <para>
    In step two of the &smt; configuration you need to enter a database
    password and specify an e-mail address for getting reports. Refer to
    <ulink url="http://www.suse.com/documentation/smt11/"/> for the complete
    <citetitle>SMT for SUSE Linux Enterprise 11 Guide</citetitle>.
   </para>
  </sect2>

  <sect2 id="sec.depl.inst.admserv.os.crowbar">
   <title>&crow; Setup</title>
   <para>
    This &yast; module allows you to basically configure all networks
    within the cloud and set the network mode for all networks. Furthermore
    you can also change the username and password for
    the &crow; Web interface with which you can manage the &ostack;
    nodes.
   </para>
   <para>
    Start &yast; and choose <menuchoice> <guimenu>Miscellaneous</guimenu>
    <guimenu>Crowbar</guimenu> </menuchoice> to start the &yast; &crow;
    module. The <guimenu>Administration Settings</guimenu> tab lets you
    change the username and password for the &crow; web interface.
   </para>
   <para>
    On the <guimenu>Network Mode</guimenu> tab you can choose between
    <guimenu>single</guimenu>, <guimenu>dual</guimenu> and
    <guimenu>team</guimenu> mode. When choosing <guimenu>team</guimenu>, you
    also need to set the <guimenu>Bonding Policy</guimenu>. See <xref
    linkend="sec.depl.req.network.modes"/> for details on &cloud; and network
    modes. In-depth information about the <guimenu>Bonding Policy</guimenu>
    (also known as bonding modes) is available at <ulink
    url="https://www.kernel.org/doc/Documentation/networking/bonding.txt"/>
    in section <citetitle>2. Bonding Driver Options</citetitle> under
    <citetitle>mode</citetitle>.
   </para>
   <para>
    If you do not want to use the default IP addresses and the default
    address allocation change these settings on the
    <guimenu>Networks</guimenu> tab. See <xref
    linkend="sec.depl.req.network"/> for details on the cloud network. You
    can also change the Bridge and VLAN allocation on the
    <guimenu>Networks</guimenu> tab. Only change them if you really know what
    you do, sticking with the defaults is recommended. 
   </para>
   <para>
    If you want to separate the admin and the BMC network, you must change
    the settings for the networks <guimenu>bmc</guimenu> and
    <guimenu>bmc_vlan</guimenu>. The <guimenu>bmc_vlan</guimenu> is used to
    used to generate a vlan tagged interface on the &admserv; that can access
    the <guimenu>bmc</guimenu> network. The <guimenu>bmc_vlan</guimenu> needs
    to be in the in the same ranges as <guimenu>bmc</guimenu> and
    <guimenu>bmc</guimenu> has to have have <guimenu>VLAN</guimenu> enabled. 
   </para>
   <table>
    <title>Separate BMC Network Example Configuration</title>
    <tgroup cols="3">
     <colspec colnum="1" colname="1" colwidth="20*"/>
     <colspec colnum="2" colname="2" colwidth="40*"/>
     <colspec colnum="3" colname="3" colwidth="40*"/>
     <thead>
      <row>
       <entry><para/></entry>
       <entry align="center"><para>bmc</para></entry>
       <entry align="center"><para>bmc_vlan</para></entry>
      </row>
     </thead>
     <tbody>
      <row>
       <entry><para>Subnet</para></entry>
       <entry namest="2" nameend="3" align="center">
        <para>
         <systemitem class="etheraddress">192.168.126.0</systemitem>
        </para>
       </entry>
      </row>
      <row>
       <entry><para>Netmask</para></entry>
       <entry namest="2" nameend="3" align="center">
        <para>
         <systemitem class="etheraddress">255.255.255.0</systemitem>
        </para>
       </entry>
      </row>
      <row>
       <entry><para>Router</para></entry>
       <entry namest="2" nameend="3" align="center">
        <para>
         <systemitem class="etheraddress">192.168.126.1</systemitem>
        </para>
       </entry>
      </row>
      <row>
       <entry><para>Broadcast</para></entry>
       <entry namest="2" nameend="3" align="center">
        <para>
         <systemitem class="etheraddress">192.168.126.255</systemitem>
        </para>
       </entry>
      </row>
      <row>
       <entry><para>Host Range</para></entry>
       <entry>
        <para>
         <systemitem class="etheraddress">192.168.126.10</systemitem> -
         <systemitem class="etheraddress">192.168.126.100</systemitem>
        </para>
       </entry>
       <entry>
        <para>
         <systemitem class="etheraddress">192.168.126.101</systemitem> -
         <systemitem class="etheraddress">192.168.126.101</systemitem>
        </para>
       </entry>
      </row>
      <row>
       <entry><para>VLAN</para></entry>
       <entry namest="2" nameend="3" align="center"><para>yes</para></entry>
      </row>
      <row>
       <entry><para>VLAN ID</para></entry>
       <entry namest="2" nameend="3" align="center"><para>100</para></entry>
      </row>
      <row>
       <entry><para>Bridge</para></entry>
       <entry namest="2" nameend="3" align="center"><para>no</para></entry>
      </row>
     </tbody>
    </tgroup>
   </table>
   
   <important>
    <title>
     No Network Changes after Having Run the Cloud Installation Script
    </title>
    <para>
     As of &productname; &productnumber; it is not possible to change the
     network setup after having run the cloud installation script. Allowing
     such changes is planned for future releases of &productname;.
    </para>
   </important>
   
   <note>
    <title>Setting up a Bastion Network</title>
    <para>
     As of &productname; &productnumber; it is not possible to set up a
     bastion network with &yast; &crow;. It needs to be configured
     manually, see <xref linkend="sec.depl.inst.admserv.post.bastion"/>.
    </para>
   </note>
   <para>
    &l3-network-support;
   </para>
  </sect2>
 </sect1>
 
 <sect1 id="sec.depl.inst.admserv.post">
  <title>Post Installation Configuration</title>
  <para>
   After the installation has finished, you need to set up product and update
   repositories and, optionally, configure the bastion network. Once the
   &admserv; host is fully configured, start the cloud installation script.
  </para>
  
  <sect2 id="sec.depl.inst.admserv.post.smt_repos">
   <title>Setting up the &smt; Repositories (optional)</title>
   <para>
    Skip this step if you do not have installed the &smt; add-on product. In
    case you have installed it, the &smt; server was set up to be able to
    communicate with the &ncc; during the installation. In this step we will
    add and mirror the update repositories for &sls; and for
    &productname;. They will serve as the update source for the &ostack;
    nodes. Run the following commands as user &rootuser;:
   </para>

    <screen><?dbsuse-fo font-size="0.63em"?>for REPO in SLES11-SP{2-Core,2-Updates,1-Updates,1-Pool} SUSE-Cloud-1.0-{Pool,Updates}; do
  smt repos $REPO sle-11-x86_64 -e
done
smt mirror -L /var/log/smt/smt-mirror.log</screen>

<para>
 The <command>smt mirror</command> command will download approximately
 14&nbsp;GB of patches. This process may last up to several hours. A log
 file is written to <filename>/var/log/smt/smt-mirror.log</filename>.
</para>
  </sect2>

  <sect2 id="sec.depl.inst.admserv.post.local_repos">
   <title>Setting Up Local Repositories</title>
   <para>
    In order to deploy the &ostack; nodes and to provide update repositories
    for them, product and update repositories for &sls; and &productname;
    must be locally available at <filename>/srv/tftpboot</filename>. The
    source of the repositories can either be an &smt; server installed on the
    &admserv; or your company's network. Please refer to <xref
    linkend="sec.depl.req.repos"/> for details. The following table lists all
    repositories, their file system location on the SMT server, and the
    location at which they need to be made available on the &admserv;:
   </para>
   
   <variablelist id="var.depl.inst.repos">
    <title>Repository Names and Locations</title>
    <varlistentry>
     <term>SLES11-SP1-Pool</term>
     <listitem>
      <formalpara>
       <title>&smt; dir:</title>
       <para>
        <filename>/srv/www/htdocs/repo/$RCE/SLES11-SP1-Pool/slee-11-x86_64</filename>
       </para>
      </formalpara>
      <formalpara>
       <title>Local dir:</title>
       <para>
        <filename>/srv/tftpboot/repos/SLES11-SP1-Pool</filename>
       </para>
      </formalpara>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>SLES11-SP1-Updates</term>
     <listitem>
      <formalpara>
       <title>&smt; dir:</title>
       <para>
        <filename>/srv/www/htdocs/repo/$RCE/SLES11-SP1-Updates/slee-11-x86_64</filename>
       </para>
      </formalpara>
      <formalpara>
       <title>Local dir:</title>
       <para>
        <filename>/srv/tftpboot/repos/SLES11-SP1-Updates</filename>
       </para>
      </formalpara>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>SLES11-SP2-Core</term>
     <listitem>
      <formalpara>
       <title>&smt; dir:</title>
       <para>
        <filename>/srv/www/htdocs/repo/$RCE/SLES11-SP2-Core/slee-11-x86_64</filename>
       </para>
      </formalpara>
      <formalpara>
       <title>Local dir:</title>
       <para>
        <filename>/srv/tftpboot/repos/SLES11-SP2-Core</filename>
       </para>
      </formalpara>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>SLES11-SP2-Updates</term>
     <listitem>
      <formalpara>
       <title>&smt; dir:</title>
       <para>
        <filename>/srv/www/htdocs/repo/$RCE/SLES11-SP2-Updates/slee-11-x86_64</filename>
       </para>
      </formalpara>
      <formalpara>
       <title>Local dir:</title>
       <para>
        <filename>/srv/tftpboot/repos/SLES11-SP2-Updates</filename>
       </para>
      </formalpara>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>SUSE-Cloud-1.0-Pool</term>
     <listitem>
      <formalpara>
       <title>&smt; dir:</title>
       <para>
        <filename>/srv/www/htdocs/repo/$RCE/SUSE-Cloud-1.0-Pool/slee-11-x86_64</filename>
       </para>
      </formalpara>
      <formalpara>
       <title>Local dir:</title>
       <para>
        <filename>/srv/tftpboot/repos/SUSE-Cloud-1.0-Pool</filename>
       </para>
      </formalpara>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>SUSE-Cloud-1.0-Updates</term>
     <listitem>
      <formalpara>
       <title>&smt; dir:</title>
       <para>
        <filename>/srv/www/htdocs/repo/$RCE/SUSE-Cloud-1.0-Updates/slee-11-x86_64</filename>
       </para>
      </formalpara>
      <formalpara>
       <title>Local dir:</title>
       <para>
        <filename>/srv/tftpboot/repos/SUSE-Cloud-1.0-Updates</filename>
       </para>
      </formalpara>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term>&sls; 11 SP2 Product</term>
     <listitem>
      <formalpara>
       <title>&smt; dir:</title>
       <para>
        n/a
       </para>
      </formalpara>
      <formalpara>
       <title>Local dir:</title>
       <para>
        <filename>/srv/tftpboot/suse-11.2</filename>
       </para>
      </formalpara>
     </listitem>
    </varlistentry>   
   </variablelist>

   
   <sect3 id="sec.depl.inst.admserv.post.local_repos.update">
    <title>Update Repositories</title>
    <para>
     The update repositories for &sls; and &productname; not only need to be
     available locally on the &admserv;, they also need to be kept in sync
     with the official update repositories provided by &ncc;. It is highly
     recommended to install an &smt; server either on the &admserv; or within
     your company network. An &smt; server automatically synchronizes the
     repositories with the &ncc;. There are several possibilities to make the
     repositories locally available on the &admserv; 
    </para>
    <variablelist>
     <varlistentry>
      <term>&smt; Server installed on the &admserv;</term>
      <listitem>
       <para>
        Link the repositories mirrored by &smt; to
        <filename>/srv/tftpboot</filename>:
       </para>
        <screen><?dbsuse-fo font-size="0.63em"?>for REPO in SLES11-SP{2-Core,2-Updates,1-Updates,1-Pool} SUSE-Cloud-1.0-{Pool,Updates}; do
  ln -s /srv/www/htdocs/repo/\$RCE/$REPO/sle-11-x86_64 /srv/tftpboot/repos/$REPO
done</screen>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>&smt; Server installed on a Remote Host</term>
      <listitem>
       <para>
        If the &smt; server is installed on a remote host that can be accessed
        from the &admserv; you can either mount the update repositories, for
        example via <literal>NFS</literal>, or regularly
        <command>rsync</command> them.
       </para>
       <para>
        To <literal>NFS</literal>-mount the repositories from a remote host,
        either use the &yast; <guimenu>NFS Client</guimenu> module or edit
        <filename>/etc/fstab</filename>. The local mount point should be
        <filename>/srv/tftpboot/repos/<replaceable>&lt;REPOSITORY_NAME&gt;</replaceable></filename>.
       </para>
       <para>
        To <command>rsync</command> the repositories from a remote host,
        create a daily cron job running the following command on the
        &admserv;. This command will <emphasis>pull</emphasis> the files from
        a host named &smt;.&exampledomain;:
       </para>
       <screen><?dbsuse-fo font-size="0.63em"?>for REPO in SLES11-SP{2-Core,2-Updates,1-Updates,1-Pool} SUSE-Cloud-1.0-{Pool,Updates}; do
  rsync -avPz &smt;.&exampledomain;:/srv/www/htdocs/repo/\$RCE/$REPO/sle-11-x86_64/ \
  /srv/tftpboot/repos/$REPO/
done</screen>
       <para>
        Alternatively you may set up the cron job on the remote host and
        <emphasis>push</emphasis> the file to the &admserv; (which has the IP
        address <systemitem class="etheraddress">192.168.124.10</systemitem>
        in the following example):.
       </para>
       <screen><?dbsuse-fo font-size="0.63em"?>for REPO in SLES11-SP{2-Core,2-Updates,1-Updates,1-Pool} SUSE-Cloud-1.0-{Pool,Updates}; do
  rsync -avPz /srv/www/htdocs/repo/\$RCE/$REPO/sle-11-x86_64/ \
  <replaceable>192.168.124.10</replaceable>:/srv/tftpboot/repos/$REPO/ \
done</screen>
       <note>
        <title>Mind the Trailing Slash</title>
        <para>
         The <command>rsync</command> command must be used with a trailing
         slashes in the directory names as shown above. Otherwise rsync would
         copy the repositories into the wrong directory.
        </para>
       </note>
      </listitem>
     </varlistentry>
     <varlistentry>
      <term>Sneakernet</term>
      <listitem>
       <para>
        If your admin network is isolated from other networks, you need to
        manually sync the update repositories from removable media. To do so
        you can either use <command>rsync</command> (see above for an example)
        or <command>cp <option>-axu</option></command>.
       </para>
      </listitem>
     </varlistentry>
    </variablelist>
   </sect3>
   
   <sect3 id="sec.depl.inst.admserv.post.local_repos.product">
    <title>Product Repositories</title>
    <para>
     The files in the product repositories for &sls; and &cloud; do not
     change, therefore they do not need to be synced with a remote source. It
     is sufficient to copy the data once, either from a remote host or
     directly from the installation media. Alternatively you may mount the
     product repository from a remote server via
     <literal>NFS</literal>. Please note that the data
     <emphasis>must</emphasis> be directly available from the local
     directories listed in <xref linkend="var.depl.inst.repos"/>. It is not
     possible to use links.
    </para>
    <para>
     If copying, it is recommended to use <command>rsync</command>. If the
     installation data is located on a removable device, make sure to mount it
     first (for example, after inserting the DVD in the &admserv; and waiting
     for the device to become ready):
    </para>
    <screen>mkdir -p /srv/tftpboot/suse-11.2/install/
mount /dev/dvd /mnt
rsync -avP /mnt/ /srv/tftpboot/suse-11.2/install/
umount /mnt</screen>
    <para>
     If the installation data is provided by a remote machine, log in to that
     machine and push the data to the &admserv; (which has the IP address
     <systemitem class="etheraddress">192.168.124.10</systemitem> in the
     following example):
    </para>
    <screen>rsync -avPz /data/sles11sp2/ <replaceable>192.168.124.10</replaceable>:/srv/tftpboot/suse-11.2/install/</screen>
    <para>
     Also Make the contents of the &productname; product repository available
     at <filename>/srv/tftpboot/repos/Cloud/</filename> using one of the
     techniques described in the previous step.
    </para>
   </sect3>
   
   <sect3 id="sec.depl.inst.admserv.post.local_repos.sources">
    <title>Software Repository Sources</title>
    <para>
     Now that the product and update repositories for &sls; and &productname;
     are available locally, the &ostack; nodes can be installed and updated
     from these sources. However, it also makes sense to use these
     repositories as resources to install and update packages on the &admserv;
     as well. Therefore you need to replace the existing remote repositories
     that have been added automatically during the product registration by the
     local ones. You can either use zypper or the &yast; module
     <guimenu>Software Repositories</guimenu> to do so. 
    </para>
    <para>
     One way to do so, would be to disable all existing remote services and
     repositories and to add the local repositories afterwards:
    </para>
    <screen><?dbsuse-fo font-size="0.63em"?>zypper ms -dR --remote
zypper mr -dR --remote
for REPO in SLES11-SP{2-Core,2-Updates,1-Updates,1-Pool} SUSE-Cloud-1.0-{Pool,Updates}; do
  zypper ar -f /srv/tftpboot/repos/$REPO $REPO
done
zypper ar /srv/tftpboot/repos/Cloud "SUSE-Cloud-1.0"
zypper ar /srv/tftpboot/suse-11.2/install/ "SLES 11 SP2"</screen>
    
    <important>
     <title>Remote Repositories and Services Need to be Disabled</title>
     <para>
      The cloud Installation Script will refresh all active repositories and
      services. In case repositories cannot be refreshed, the script will
      fail. Even if you have a permanent internet connection on the &admserv;,
      it may temporarily not be available during the run of the cloud
      installation script, since this script also re-configures the network.
     </para>
     <para>
      Therefore all remote repositories and services need to be disabled prior
      to running the cloud installation script. This is archived by running
      the <command>zypper <option>ms</option></command> and <command>zypper
      <option>mr</option></command> commands listed above. In case you need
      remote repositories (such as the SMT update repositories), re-enable
      them after the cloud installation script run.
     </para>
    </important>
   </sect3>
  </sect2>
  
  <sect2 id="sec.depl.inst.admserv.post.bastion">
   <title>Setting Up a Bastion Network</title>
   <para>
    As outlined in <xref linkend="sec.depl.req.network"/>, one way to access
    the admin network from a defined external network is via a Bastion
    network and a second network card (opposed to providing an external
    gateway).
   </para>
   <para>
    To set up the Bastion network, you need to have a static IP address for
    the &admserv; from the external network. You need to adjust the network
    template file
    <filename>/opt/dell/chef/data_bags/crowbar/bc-template-network.json</filename>. The
    example configuration used below assumes that the external network from
    which to access the admin network has the following addresses. You need
    to adjust them according to your needs.
   </para>
   <simplelist>
    <member>
     Subnet: <systemitem class="etheraddress">10.10.1.0</systemitem>
    </member>
    <member>
     Netmask: <systemitem class="etheraddress">255.255.0.0</systemitem>
    </member>
    <member>
     Broadcast: <systemitem class="etheraddress">10.10.1.255</systemitem>
    </member>
    <member>
     Gateway: <systemitem class="etheraddress">10.10.1.1</systemitem>
    </member>
    <member>
     Static &admserv; address: <systemitem class="etheraddress">10.10.1.125</systemitem>
    </member>
   </simplelist>
   <para>
    Adjust
    <filename>/opt/dell/chef/data_bags/crowbar/bc-template-network.json</filename>
    according to the following patch (it only directly matches if you have not
    changed the default network configuration). Once the bastion network
    configuration has been added to
    <filename>bc-template-network.json</filename>, it can be adjusted using
    the &yast; &crow; module.
   </para>
   <screen>
--- /opt/dell/chef/data_bags/crowbar/bc-template-network.json
+++ /opt/dell/chef/data_bags/crowbar/bc-template-network.json
@@ -86,6 +86,11 @@
                         "1g1"
                      ]
                   },
+                  "bastion1" : {
+                     "if_list" : [
+                        "1g2"
+                     ]
+                  },
                   "intf1" : {
                      "if_list" : [
                         "1g1"
@@ -209,6 +214,23 @@
                "subnet" : "192.168.122.128",
                "use_vlan" : true
             },
+            "bastion" : {
+               "add_bridge" : false,
+               "vlan" : 50,
+               "router" : "10.10.1.1",
+               "ranges" : {
+                  "admin" : {
+                     "start" : "10.10.1.125",
+                     "end" : "10.10.1.125"
+                  }
+               },
+               "broadcast" : "10.10.1.255",
+               "netmask" : "255.255.255.0",
+               "use_vlan" : false,
+               "conduit" : "bastion1",
+               "subnet" : "10.10.1.0",
+               "router_pref" : 5
+            },
             "public" : {
                "add_bridge" : false,
                "vlan" : 300,</screen>

  </sect2>

  <sect2 id="sec.depl.inst.admserv.post.cloud_installation">
   <title>Running the Cloud Installation Script</title>
   <para>
    Before running the cloud installation script to finish the configuration
    of the &admserv; make sure to double-check the following items.
   </para>
   <itemizedlist>
    <title>Final Check Points</title>
    <listitem>
     <para>
      Make sure the network configuration is correct. Run <menuchoice>
      <guimenu>&yast;</guimenu> <guimenu>&crow;</guimenu> </menuchoice> to
      review/change the config. See <xref
      linkend="sec.depl.inst.admserv.os.crowbar"/> for further instructions.
     </para>
    </listitem>
    <listitem>
     <para>
      Make sure <command>hostname <option>-f</option></command> returns a full
      qualified hostname. See <xref
      linkend="sec.depl.inst.admserv.os.network"/> for further instructions.
     </para>
    </listitem>
    <listitem>
     <para>
      Make sure all update and product repositories are available
      locally. See <xref linkend="sec.depl.inst.admserv.post.local_repos"/>
      for further instructions.
     </para>
    </listitem>
    <listitem>
     <para>
      Make sure the operating system and &productname; are up-to-date and
      have the latest patches installed. Run <command>zypper patch</command>
      to install them.
     </para>
    </listitem>
   </itemizedlist>

   <para>
    Now everything is in place to finally configure the &admserv;. This is
    done by running the script
    <filename>/opt/dell/bin/install-chef-suse.sh</filename>. This command
    will install and configure &chef;, and use it to complete the
    installation of &crow; and all required &barcl;. It will take several
    minutes to complete.
   </para>
   <screen>screen /opt/dell/bin/install-chef-suse.sh</screen>
   <important>
    <title>
     Use a Terminal Multiplexer to run the Cloud Installation Script
    </title>
    <para>
     Run the installation script <filename>install-chef-suse.sh</filename> 
     inside of a terminal multiplexer like GNU Screen 
     (provided by the <systemitem class="resource">screen</systemitem> package).
    </para>
    <remark condition="clarity">
     2012-09-19 - fs: not mentioning tmux, since it is not included with SLES
    </remark>
    <para>
     During the run of this script the network will be reconfigured. This may
     result in interrupting the script when being run from a network
     connection (like SSH). Using <command>screen</command> will continue
     running the script in a session to which you can reconnect via
     <command>screen -r</command> if you lose the connection.
    </para>
   </important>
   <para>
    <command>install-chef-suse.sh</command> will produce a lot of output that
    gets written to a log file located at
    <filename>/var/log/chef/install.log</filename>. Check this log file in
    case something goes wrong. You can run
    <command>install-chef-suse.sh</command> multiple times as long as you
    have not started to deploy the &ostack; services.
   </para>
   <para>
    If the script has successfully finished, you will see a message telling
    you how to log in to the &crow; Web interface. 
   </para>
   <warning>
    <title>
     No Network Changes After Having Run the Cloud Installation Script
    </title>
    <para>
     Once you have run the cloud installation script, you can not change the
     network setup anymore. If doing so, you would have to completely set up
     the &admserv; again.
    </para>
   </warning>
   <sect3 id="sec.depl.inst.admserv.post.cloud_installation.bastion">
    <title>Activating the Bastion Network</title>
    <para>
     In case you have configured a Bastion Network, you need to activate it's
     network interface by running the following commands:
    </para>
    <screen>/opt/dell/bin/crowbar network -U crowbar -P crowbar allocate_ip \
  default $(hostname -f) bastion admin
chef-client</screen>
    <para>
     This command needs to be executed directly on the admin server, so you
     either need direct access to the machine or a serial console.
    </para>
   </sect3>
   <sect3 id="sec.depl.inst.admserv.post.cloud_installation.remote_repos">
    <title>Re-enabling Remote Repositories</title>
    <para>
     Prior to running the cloud installation script, all required update
     repositories have been made available locally and all remote repositories
     and services have been disabled (see <xref
     linkend="sec.depl.inst.admserv.post.local_repos.sources"/>). In case you
     still need remote repositories that have been disabled
     (e.g. SLE11-SMT-SP2-Pool and SLE11-SMT-SP2-Updates if you have installed
     &smt;), you may re-enable them now using &yast; or zypper.
    </para>
   </sect3>
  </sect2>
 </sect1>
</chapter>
