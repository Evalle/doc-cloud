<?xml version="1.0" encoding="utf-8"?>
<?xml-stylesheet
href="urn:x-daps:xslt:profiling:novdoc-profile.xsl"
type="text/xml"
title="Profiling step"?>
<!DOCTYPE chapter PUBLIC "-//Novell//DTD NovDoc XML V1.0//EN" "novdocx.dtd"
[
<!ENTITY % NOVDOC.DEACTIVATE.IDREF "IGNORE">
<!ENTITY % entities SYSTEM "entity-decl.ent">
%entities;
]>
<chapter id="cha.depl.inst">
 <title>Installing and Configuring the &admserv;</title>
 <abstract>
  <para>
   Deploying and installing &productname; is a multi-step process, starting
   by deploying a basic &sls; installation and the &productname; add-on
   product to the &admserv;. Now the product and update repositories need to
   be set up and the &cloud; network needs to be configured. Next the
   &admserv; setup will be finished. Once the &admserv; is ready, you can
   start deploying and configuring the &ostack; nodes. The complete node
   deployment is done automatically via &crow; and &chef; from the
   &admserv;. All you need to do is to PXE boot the nodes and to deploy the
   &ostack; services to them.
  </para>
 </abstract>
 <procedure>
  <title>High Level Overview of the &cloud; Installation</title>
  <step>
   <para>
    Install &sls; 11 SP3 on the &admserv; with the add-on products &smtool;
    (optional) and &cloud;. See below.
   </para>
  </step>
  <step>
   <para>
    Once the &admserv; is set up, PXE boot all nodes onto which the &ostack;
    components should be deployed and allocate them in the &crow; Web
    interface to start the automatic &sls; installation. See
    <xref
      linkend="cha.depl.inst.nodes"/>.
   </para>
  </step>
  <step>
   <para>
    Configure and deploy the &ostack; services via the &crow; Web interface
    or command line tools. See <xref linkend="cha.depl.ostack"/>.
   </para>
  </step>
  <step>
   <para>
    When all &ostack; services are up and running, &cloud; is ready. The
    cloud administrator can now upload images to enable users to start deploying
    &vmguest;s. See <xref linkend="book.cloud.admin"/>.
   </para>
  </step>
 </procedure>
 <para>
  In this chapter you will learn how to install and set up the &admserv;
  from bare-metal. As a result, the &admserv; will be ready to deploy
  &ostack; nodes and services. It will run on &sls; 11 SP3 and will include
  the add-on products &productname; and &smt;. Installing the &admserv;
  involves the following basic steps:
 </para>
 <sect1 id="sec.depl.inst.admserv.os">
  <title>Operating System Installation</title>

  <para>
   Start the installation by booting from the &sls; 11 SP3 installation
   medium.
  </para>

  <note>
   <title>Differences from the Default Installation Process</title>
   <para>
    For an overview of a default &sls; installation, refer to the &sls;
    &instquick;. Detailed installation instructions are available in the
    &sls; <citetitle>Deployment Guide</citetitle>. Both documents are
    available at <ulink url="http://www.suse.com/documentation/sles11/"/>.
   </para>
   <para>
    The following sections will only cover the differences from the default
    installation process.
   </para>
  </note>

  <sect2 id="sec.depl.inst.admserv.os.add_on">
   <title>Add-On Product Selection</title>
   <para>
    &cloud; is an add-on product to &sls;. Installing it during the the
    &sls; installation is the easiest and recommended way to set up the
    &admserv;. If you are planning to set up an &smt; server on the
    &admserv; as well, also install it in this step (&smt; is an add-on
    product, too). Make sure to be able to access the installation media
    (DVD or ISO image) for all add-on products. Alternatively, install the
    add-on products after the &sls; installation.
   </para>
   <note>
    <title>&smt; Server Installation</title>
    <para>
     When not using an existing &smt; or &susemgr; server, installing an
     &smt; server on the &admserv; is the easiest way to ensure that &cloud;
     is provided with up-to-date update repositories for &sls; and &cloud;.
     See <xref linkend="sec.depl.req.repos"/> for alternatives and
     background information.
    </para>
   </note>
   <para>
    On the <guimenu>Installation Mode</guimenu> screen, click
    <guimenu>Include Add-On products from Separate Media</guimenu>. Proceed
    with <guimenu>Next</guimenu> to the Add-On product installation dialog.
    If you have direct access to the installation media (for example, via
    DVD or USB stick), skip the network installation dialog. Otherwise
    configure the network as described in
    <xref
      linkend="sec.depl.inst.admserv.os.network"/>. Add &cloud; and
    &smt; (optional) as add-on products and proceed with the installation.
    Consult the &sls; <citetitle>Deployment Guide</citetitle> at
    <ulink
      url="http://www.suse.com/documentation/sles11/book_sle_deployment/data/sec_i_yast2_inst_mode.html"/>
    for detailed instructions.
   </para>
  </sect2>

  <sect2 id="sec.depl.inst.admserv.os.partition">
   <title>Partitioning</title>
   <para>
    Currently, &crow; requires <filename>/opt</filename> to be writable.
    Apart from that, &cloud; has no special requirements in regards of
    partitioning. However, it is recommended to create a separate partition or
    volume for <filename>/srv</filename>. /srv will host all update and
    product repositories for &sls; and &cloud;. A size of at least &repospace;
    is required. Help on using the partitioning tool is available at <ulink
    url="http://www.suse.com/documentation/sles11/book_sle_deployment/data/sec_yast2_i_y2_part_expert.html"/>.
   </para>
  </sect2>

  <sect2 id="sec.depl.inst.admserv.os.software">
   <title>Software Selection</title>
   <para>
    Installing a minimal base system is sufficient to set up the &admserv;.
    The following patterns are the minimum requirement:
   </para>
   <itemizedlist>
    <listitem>
     <para>
      <guimenu>Base System</guimenu>
     </para>
    </listitem>
    <listitem>
     <para>
      <guimenu>Minimal System (Appliances)</guimenu>
     </para>
    </listitem>
    <listitem>
     <para>
      <guimenu>Subscription Management Tool</guimenu> (optional)
     </para>
    </listitem>
    <listitem>
     <para>
      <guimenu>SUSE Cloud Admin Node</guimenu>
     </para>
    </listitem>
    <listitem>
     <para>
      <guimenu>Web and LAMP Server</guimenu> (only needed when installing
      &smt;)
     </para>
    </listitem>
   </itemizedlist>
  </sect2>

  <sect2 id="sec.depl.inst.admserv.os.registration">
   <title>Product Registration</title>
   <para>
    Although you can also register your products at any time after the
    installation, it is recommended to register &sls; and &productname; now,
    because it will give you immediate access to the update channels. If you
    have installed the &smt; Add-On product, you <emphasis>must</emphasis>
    register your &sls; version at the &ncc; <emphasis>now</emphasis>,
    otherwise you will not be able to configure the &smt; server. You have
    received registration keys with the &cloud; &admserv; subscription. See
    <ulink
      url="http://www.suse.com/documentation/sles11/book_sle_deployment/data/sec_i_yast2_conf.html"/>
    for details on the &ncc; registration.
   </para>
   <note>
    <title>&suse; Login Required</title>
    <para>
     In order to register a product, you need to have a &suse;/&novell;
     login. If you do not have such a login, create it at
     <ulink
       url="http://www.suse.com/login"/>.
    </para>
   </note>
  </sect2>

  <sect2 id="sec.depl.inst.admserv.os.online_update">
   <title>Online Update</title>
   <para>
    A successful product registration will add update repositories for &sls;
    and all add-on products. After having successfully registered you will
    be asked to perform an online update, which will update the system and
    the add-on products. It is strongly recommended to perform the update at
    this point in time. If you choose to skip the update now, you must
    perform it later, before running the Cloud installation script.
   </para>
  </sect2>

  <sect2 id="sec.depl.inst.admserv.os.ca">
   <title>CA Setup</title>
   <para>
    Skip this step if you have not installed &smt; add-on product. In case
    you have installed &smt; you need to provide a certification authority
    (CA). If you already have a CA certificate in your organization, import
    it. Otherwise generate all certificates in the &admserv; itself by
    accepting the &yast; proposal. See
    <ulink
      url="http://www.suse.com/documentation/sles11/book_security/data/cha_security_yast_ca.html"/>
    for more information.
   </para>
   <para>
    If &smt; is not installed, click on the <guimenu>CA Management</guimenu>
    link and choose to not set up a CA.
   </para>
  </sect2>

  <sect2 id="sec.depl.inst.admserv.os.network">
   <title>Basic Network Configuration</title>
   <para>
    Only the first interface
    (<systemitem class="resource">eth0</systemitem>) on the &admserv; needs
    to be configured during the installation. Other interfaces will be
    automatically configured by the cloud installation script.
   </para>
   <para>
    <systemitem class="resource">eth0</systemitem> needs to be given a fixed
    IP address from the admin network&mdash;when sticking with the default
    network addresses this would be
    <systemitem
      class="etheraddress">192.168.124.10</systemitem>. The
    address you need to enter for the <guimenu>Default Gateway</guimenu>
    depends on whether you have provided an external gateway for the admin
    network (use the address of that gateway) or not (use
    <replaceable>xxx.xxx.xxx</replaceable>.1, e.g.
    <systemitem class="etheraddress">192.168.124.1</systemitem>). Using a
    custom IP address or more than one network interfaces requires to adjust
    the &crow; configuration in a later step as described in
    <xref
      linkend="sec.depl.inst.admserv.os.crowbar"/>.
   </para>
   <para>
    If the &admserv; has access to the outside, you can add additional name
    servers that will automatically be used to forward requests. The
    &admserv;'s name server will automatically be configured by the cloud
    installation script to forward requests for non-local records to those
    server(s).
   </para>
   <para>
    You also need to assign a hostname and a fully qualified domain name
    (FQDN) such as <replaceable>admin.cloud.&exampledomain;</replaceable> to
    <systemitem class="resource">eth0</systemitem> (tab
    <guimenu>Hostname/DNS</guimenu> in the <guimenu>Network settings
    Dialog</guimenu>).
   </para>
   <para>
    Last, the firewall needs to be disabled for all interfaces.
   </para>
   <important>
    <title>&admserv; Domain Name and Hostname</title>
    <para>
     Setting up the &cloud; will also install a DNS server for all nodes in
     the cloud. The domainname you specify for the &admserv; will be used
     for the DNS zone. It is recommended to use a sub-domain such as
     <replaceable>cloud.&exampledomain;</replaceable>.
    </para>
    <para>
     The hostname and the FQDN need to be resolvable with <command>hostname
     <option>-f</option></command>. Double-check whether
     <filename>/etc/hosts</filename> contains an appropriate entry for the
     &admserv;. It should look like the following:
    </para> 
    <screen>192.168.124.10 admin.cloud.&exampledomain; admin</screen>
    <para>
     It is <emphasis>not</emphasis> possible to change the &admserv;
     hostname or the FQDN once the cloud installation script has been run.
    </para>
   </important>
  </sect2>

  <sect2 id="sec.depl.inst.admserv.os.smt">
   <title>&smt; Configuration</title>
   <para>
    Skip this step if you have not installed the &smt; add-on product. In
    case you have installed it, you will be asked to configure it.
    Configuring the &smt; server requires you to have your mirroring
    credentials (username and password) and your registration e-mail address
    at hand. To access them, log in to the &ncc; at
    <ulink url="http://www.novell.com/center/"/>. Get the mirror credentials
    by selecting <menuchoice> <guimenu>My Products</guimenu> <guimenu>Mirror
    Credentials</guimenu> </menuchoice> in the left navigation. Obtain your
    registration e-mail address from <menuchoice> <guimenu>My
    Profile</guimenu> <guimenu>Login Profile</guimenu> </menuchoice>.
   </para>
   <para>
    Enter this data at the <guimenu>SMT Configuration Wizard Step
    1/2</guimenu> into the fields <guimenu>User</guimenu>,
    <guimenu>Password</guimenu>, and <guimenu>NCC E-mail Used for
    Registration</guimenu>. Accept the pre-filled defaults for the other
    input fields. Make sure to <guimenu>Test</guimenu> the credentials.
   </para>
   <para>
    In step two of the &smt; configuration you need to enter a database
    password and specify an e-mail address for getting reports. Refer to
    <ulink url="http://www.suse.com/documentation/smt11/"/> for the complete
    <citetitle>SMT for SUSE Linux Enterprise 11 Guide</citetitle>.
   </para>
  </sect2>

  <sect2 id="sec.depl.inst.admserv.os.crowbar">
   <title>&crow; Setup</title>
   <para>
    This &yast; module enables you to configure all networks within the
    cloud, to set up additional repositories and to manage the &crow; users.
    This module is automatically started when installing &productname;. To
    start it manually after the installation, either run <command>yast
    crowbar</command> or choose <menuchoice> <guimenu>Miscellaneous</guimenu>
    <guimenu>Crowbar</guimenu> </menuchoice> in &yast;.
   </para>
   <sect3 id="sec.depl.inst.admserv.os.crowbar.user">
    <title><guimenu>User Settings</guimenu></title>
    <para>
     On this tab you can manage users for the &crow; Web interface. The user
     <systemitem class="username">crowbar</systemitem> (password
     <literal>crowbar</literal>) is pre-configured. Use the
     <guimenu>Add</guimenu>, <guimenu>Edit</guimenu> and
     <guimenu>Delete</guimenu> buttons to manage user accounts.  Users
     configured here have no relations to existing system users on the
     &admserv;.
    </para>
   </sect3>
   <sect3 id="sec.depl.inst.admserv.os.crowbar.network">
    <title><guimenu>Networks</guimenu></title>
    <para>
     Use the <guimenu>Networks</guimenu> tab to change the default network
     setup (described in <xref linkend="sec.depl.req.network"/>). Change the
     IP address assignment for each network under <guimenu>Edit
     Ranges</guimenu>. You may also add a bridge (<guimenu>Add
     Bridge</guimenu>) or a VLAN (<guimenu>Use VLAN</guimenu>, <guimenu>VLAN
     ID</guimenu>)to a network. Only change the latter two settings if you
     really know what you require, sticking with the defaults is recommended.
    </para>
    &vlan-settings;
    &no_network_changes;
    <para>
     &l3-network-support;
    </para>
    <sect4 id="sec.depl.inst.admserv.os.crowbar.network.bmc">
     <title>Separating the Admin and the BMC Network</title>
     <para>
      If you want to separate the admin and the BMC network, you must change
      the settings for the networks <guimenu>bmc</guimenu> and
      <guimenu>bmc_vlan</guimenu>. The <guimenu>bmc_vlan</guimenu> is used to
      generate a VLAN tagged interface on the &admserv; that can access the
      <guimenu>bmc</guimenu> network. The <guimenu>bmc_vlan</guimenu> needs to
      be in the same ranges as <guimenu>bmc</guimenu>, and
      <guimenu>bmc</guimenu> has to have <guimenu>VLAN</guimenu> enabled.
     </para>
     <table>
      <title>Separate BMC Network Example Configuration</title>
      <tgroup cols="3">
       <colspec colnum="1" colname="1" colwidth="20*"/>
       <colspec colnum="2" colname="2" colwidth="40*"/>
       <colspec colnum="3" colname="3" colwidth="40*"/>
       <thead>
	<row>
	 <entry>
          <para/>
	 </entry>
	 <entry align="center">
          <para>
           bmc
          </para>
	 </entry>
	 <entry align="center">
          <para>
           bmc_vlan
          </para>
	 </entry>
	</row>
       </thead>
       <tbody>
	<row>
	 <entry>
          <para>
           Subnet
          </para>
	 </entry>
	 <entry namest="2" nameend="3" align="center">
          <para>
           <systemitem class="etheraddress">192.168.128.0</systemitem>
          </para>
	 </entry>
	</row>
	<row>
	 <entry>
          <para>
           Netmask
          </para>
	 </entry>
	 <entry namest="2" nameend="3" align="center">
          <para>
           <systemitem class="etheraddress">255.255.255.0</systemitem>
          </para>
	 </entry>
	</row>
	<row>
	 <entry>
          <para>
           Router
          </para>
	 </entry>
	 <entry namest="2" nameend="3" align="center">
          <para>
           <systemitem class="etheraddress">192.168.128.1</systemitem>
          </para>
	 </entry>
	</row>
	<row>
	 <entry>
          <para>
           Broadcast
          </para>
	 </entry>
	 <entry namest="2" nameend="3" align="center">
          <para>
           <systemitem class="etheraddress">192.168.128.255</systemitem>
          </para>
	 </entry>
	</row>
	<row>
	 <entry>
          <para>
           Host Range
          </para>
	 </entry>
	 <entry>
          <para>
           <systemitem class="etheraddress">192.168.128.10</systemitem> -
           <systemitem class="etheraddress">192.168.128.100</systemitem>
          </para>
	 </entry>
	 <entry>
          <para>
           <systemitem class="etheraddress">192.168.128.101</systemitem> -
           <systemitem class="etheraddress">192.168.128.101</systemitem>
          </para>
	 </entry>
	</row>
	<row>
	 <entry>
          <para>
           VLAN
          </para>
	 </entry>
	 <entry namest="2" nameend="3" align="center">
          <para>
           yes
          </para>
	 </entry>
	</row>
	<row>
	 <entry>
          <para>
           VLAN ID
          </para>
	 </entry>
	 <entry namest="2" nameend="3" align="center">
          <para>
           100
          </para>
	 </entry>
	</row>
	<row>
	 <entry>
          <para>
           Bridge
          </para>
	 </entry>
	 <entry namest="2" nameend="3" align="center">
          <para>
           no
          </para>
	 </entry>
	</row>
       </tbody>
      </tgroup>
     </table>
    </sect4>
   </sect3>
   <sect3 id="sec.depl.inst.admserv.os.crowbar.mode">
    <title><guimenu>Network Mode</guimenu></title>
    <para>
     On the <guimenu>Network Mode</guimenu> tab you can choose between
     <guimenu>single</guimenu>, <guimenu>dual</guimenu>, and
     <guimenu>team</guimenu> mode. When choosing <guimenu>team</guimenu>, you
     also need to set the <guimenu>Bonding Policy</guimenu>. See <xref
     linkend="sec.depl.req.network.modes"/> for details on &cloud; and network
     modes. In-depth information about the <guimenu>Bonding Policy</guimenu>
     (also known as bonding modes) is available at <ulink
     url="https://www.kernel.org/doc/Documentation/networking/bonding.txt"/>
     in section 2, <citetitle>Bonding Driver Options</citetitle>, under
     <citetitle>mode</citetitle>.
    </para>
    <sect4 id="sec.depl.inst.admserv.os.crowbar.mode.bastion">
     <title>Setting Up a Bastion Network</title>
     <para>
      The <guimenu>Network Mode</guimenu> tab of the &yast; &crow; module
      also lets you set up a Bastion network. As outlined in <xref
      linkend="sec.depl.req.network"/>, one way to access the &admserv; from a
      defined external network is via a Bastion network and a second network
      card (as opposed to providing an external gateway).
     </para>
     <para>
      To set up the Bastion network, you need to have a static IP address for
      the &admserv; from the external network. The example configuration used
      below assumes that the external network from which to access the admin
      network has the following addresses. You need to adjust them according
      to your needs.
     </para>
     <table>
      <title>Example Addresses for a Bastion Network</title>
      <tgroup cols="2">
       <colspec colnum="1" colname="1" colwidth="60*"/>
       <colspec colnum="2" colname="2" colwidth="40*"/>
       <tbody>
	<row>
         <entry>
          <para>
           Subnet
          </para>
         </entry>
         <entry>
          <para>
           <systemitem class="etheraddress">10.10.1.0</systemitem>
          </para>
         </entry>
	</row>
	<row>
         <entry>
          <para>
           Netmask
          </para>
         </entry>
         <entry>
          <para>
           <systemitem class="etheraddress">255.255.255.0</systemitem>
          </para>
         </entry>
	</row>
	<row>
         <entry>
          <para>
           Broadcast
          </para>
         </entry>
         <entry>
          <para>
           <systemitem class="etheraddress">10.10.1.255</systemitem>
          </para>
         </entry>
	</row>
	<row>
         <entry>
          <para>
           Gateway
          </para>
         </entry>
         <entry>
          <para>
           <systemitem class="etheraddress">10.10.1.1</systemitem>
          </para>
         </entry>
	</row>
	<row>
         <entry>
          <para>
           Static &admserv; address
          </para>
         </entry>
         <entry>
          <para>
           <systemitem class="etheraddress">10.10.1.125</systemitem>
          </para>
         </entry>
	</row>
       </tbody>
      </tgroup>
     </table>
     <para>
      In addition to the values above, you need to enter the <guimenu>Physical
      Interface Mapping</guimenu>. With this value you specify the ethernet
      card that is used for the bastion network. See <xref
      linkend="sec.deploy.network_json.conduits"/> for details on the
      syntax. The default value <literal>?1g2</literal> matches the second
      interface (<quote>eth1</quote>) of the system. 
     </para>
     <important>
      <title>Accessing Nodes From Outside the Bastion Network</title>
      <para>
       The example configuration from above allows to access &cloud; nodes
       from <emphasis>within</emphasis> the bastion network. If you want to
       access nodes from outside the bastion network, you need to make the
       router for the bastion network the default router for the
       &admserv;. This is achieved by setting the value for the bastion
       network's <guimenu>router_pref</guimenu> entry in
       /etc/crowbar/network.json to a lower value than the corresponding entry
       for the admin network. By default no router preference is set for the
       &admserv;&mdash;in this case, set the bastion network's
       <guimenu>router_pref</guimenu> to <literal>5</literal>:
      </para>
      <screen>/opt/dell/bin/json-edit -r \
-a "attributes.network.networks.bastion.router_pref" \
-v "5" /etc/crowbar/network.json</screen>
      <para>
       If you use a Linux gateway between the outside and the bastion network,
       you also need to disable route verification (rp_filter) on the
       &admserv;. Do so by running the following command on the &admserv;:
      </para>
      <screen>echo 0 > /proc/sys/net/ipv4/conf/all/rp_filter</screen>
      <para>
       That command disables route verification for the current session, so
       the setting will not <quote>survive</quote> a reboot. Make it permanent
       by editing <filename>/etc/sysctl.conf</filename> and setting the value
       for <guimenu>net.ipv4.conf.all.rp_filter</guimenu> to
       <literal>0</literal>.
      </para>
     </important>
     &no_network_changes;
    </sect4>    
   </sect3>
   
   <sect3 id="sec.depl.inst.admserv.os.crowbar.repos">
    <title><guimenu>Repositories</guimenu></title>
    <para>
     Enter URLs to remote repositories on the <guimenu>Repositories</guimenu>
     tab. This is only necessary if you want to use repositories from an
     external &smt; or &susemgr; server rather than repositories local to the
     &admserv;. In the latter case you should not enter any URLs&mdash;empty
     values mean that the default values will be used. Please consult <xref
     linkend="sec.depl.inst.admserv.post.local_repos"/> for in-depth
     information.
    </para>
    <para>
     To change the URL for a repository, choose an entry and enter the
     complete <guimenu>Repository URL</guimenu>. Activating <guimenu>Ask On
     Error</guimenu> will ensure that you will be informed, in case a
     repository will not be available during node deployment (otherwise
     errors will be silently ignored). See <xref
     linkend="sec.depl.req.repos"/> for an explanation of the
     <guimenu>Repository Names</guimenu>.
    </para>

    <note>
     <title>Configuring Custom Repositories</title>
     <para>
      As of &productname; &productnumber; it is not possible to configure
      external custom repositories with &yast;. See <xref
      linkend="q.depl.trouble.faq.admin.custom_repos"/> for manual
      configuration instructions.
     </para>
    </note>
    
   </sect3>
  </sect2>

 </sect1>
 <sect1 id="sec.depl.inst.admserv.post">
  <title>Post-Installation Configuration</title>

  <para>
   After the installation of the operating system and the add-on products
   has finished, you need to set up product and update repositories and,
   optionally, configure the bastion network. Once the &admserv; host is
   fully configured, start the cloud installation script.
  </para>

  <sect2 id="sec.depl.inst.admserv.post.smt_repos">
   <title>Setting up the &smt; Repositories</title>
   <para>
    If you are using an &smt; server (locally or from another network), you
    need to configure it to mirror the update repositories needed for
    &cloud;. Skip this step if you are not using an &smt; server (but make
    sure the repositories listed at <xref linkend="sec.depl.req.repos"/> are
    available on the &admserv;).
   </para>
   <para>
    The &smt; server mirrors the update channels from the &ncc;. In order to
    be able to access the &sls; and &productnname; repositories, make sure
    to have registered both products in &ncc;. Run the following commands as
    user &rootuser; on the &smt; server:
   </para>
<screen><?dbsuse-fo font-size="0.63em"?>for REPO in SLES11-SP3-{Pool,Updates} SUSE-Cloud-3.0-{Pool,Updates}; do
  smt-repos $REPO sle-11-x86_64 -e
done
smt-mirror -L /var/log/smt/smt-mirror.log</screen>
<para>
 The <command>smt-repos</command> command will add the list of
 repositories to the &smt; server. The <command>smt-mirror</command>
 command will mirror them and download several GB of
 patches. This process may last up to several hours. A log file is
 written to <filename>/var/log/smt/smt-mirror.log</filename>. The
 following table lists all repositories and their file system location:
</para>
<table>
 <title>&smt; Repositories for &cloud;</title>
 <tgroup cols="2">
  <colspec colnum="1" colname="1" colwidth="25*"/>
  <colspec colnum="2" colname="2" colwidth="75*"/>
  <thead>
   <row>
    <entry>
     <para>
      Repository
     </para>
    </entry>
    <entry>
     <para>
      Directory
     </para>
    </entry>
   </row>
  </thead>
  <tbody>
   <row>
    <entry>
     <para>
      SLES11-SP3-Pool
     </para>
    </entry>
    <entry>
     <para>
      <filename>/srv/www/htdocs/repo/$RCE/SLES11-SP3-Pool/sle-11-x86_64</filename>
     </para>
    </entry>
   </row>
   <row>
    <entry>
     <para>
      SLES11-SP3-Updates
     </para>
    </entry>
    <entry>
     <para>
      <filename>/srv/www/htdocs/repo/$RCE/SLES11-SP3-Updates/sle-11-x86_64</filename>
     </para>
    </entry>
   </row>
   <row>
    <entry>
     <para>
      SUSE-Cloud-3-Pool
     </para>
    </entry>
    <entry>
     <para>
      <filename>/srv/www/htdocs/repo/$RCE/SUSE-Cloud-3.0-Pool/sle-11-x86_64</filename>
     </para>
    </entry>
   </row>
   <row>
    <entry>
     <para>
      SUSE-Cloud-3-Updates
     </para>
    </entry>
    <entry>
     <para>
      <filename>/srv/www/htdocs/repo/$RCE/SUSE-Cloud-3.0-Updates/sle-11-x86_64</filename>
     </para>
    </entry>
   </row>
  </tbody>
 </tgroup>
</table>
  </sect2>

  <sect2 id="sec.depl.inst.admserv.post.local_repos">
   <title>Setting Up Repositories for Node Deployment</title>
   <para>
    In order to deploy the &ostack; nodes and to provide update repositories
    for them, product and update repositories for &sls; and &productname;
    must be configured. See <xref linkend="sec.depl.req.repos"/> for
    background information.
   </para>
   <sect3 id="sec.depl.inst.admserv.post.local_repos.product">
    <title>Product Repositories</title>
    <para>
     The files in the product repositories for &sls; and &cloud; do not
     change, therefore they do not need to be synced with a remote source.
     It is sufficient (and recommended) to copy the data once, either from a
     remote host or directly from the installation media. Alternatively you
     may mount the product repository from a remote server via
     <literal>NFS</literal>. Please note that the data
     <emphasis>must</emphasis> be directly available from the local
     directories listed below. It is not possible to use links.
    </para>
    <para>
     While the &sls; product repository must be made available locally, the
     &productname; repository may also be served via <literal>http</literal>
     from a remote host. However, copying the data (approximately
     &mediaspace;) to the &admserv; as described here, is recommended, since
     it does not require a custom network configuration for the &admserv;.
    </para>
    <para>
     The following product repositories need to be available for
     &productname; deployment:
    </para>
    <table>
     <title>Local Product Repositories for &cloud;</title>
     <tgroup cols="2">
      <colspec colnum="1" colname="1" colwidth="40*"/>
      <colspec colnum="2" colname="2" colwidth="60*"/>
      <thead>
       <row>
        <entry>
         <para>
          Repository
         </para>
        </entry>
        <entry>
         <para>
          Directory
         </para>
        </entry>
       </row>
      </thead>
      <tbody>
       <row>
        <entry>
         <para>
          SLES11 SP3 Product
         </para>
        </entry>
        <entry>
         <para>
          <filename>/srv/tftpboot/suse-11.3/install</filename>
         </para>
        </entry>
       </row>
       <row>
        <entry>
         <para>
          Cloud 3 Product
         </para>
        </entry>
        <entry>
         <para>
          <filename>/srv/tftpboot/repos/Cloud</filename>
         </para>
        </entry>
       </row>
      </tbody>
     </tgroup>
    </table>
    <sect4 id="sec.depl.inst.admserv.post.local_repos.product.media">
     <title>Copying from the Installation media</title>
     <para>
      If copying, it is recommended to use <command>rsync</command>. If the
      installation data is located on a removable device, make sure to mount
      it first (for example, after inserting the DVD in the &admserv; and
      waiting for the device to become ready):
     </para>
<screen>mkdir -p /srv/tftpboot/suse-11.3/install/
mount /dev/dvd /mnt
rsync -avP /mnt/ /srv/tftpboot/suse-11.3/install/
umount /mnt</screen>
     <para>
      Also make the contents of the &productname; product repository
      available at <filename>/srv/tftpboot/repos/Cloud/</filename> the same
      way:
     </para>
<screen>mkdir -p /srv/tftpboot/repos/Cloud/
mount /dev/dvd /mnt
rsync -avP /mnt/ /srv/tftpboot/repos/Cloud/
umount /mnt</screen>
    </sect4>
    <sect4 id="sec.depl.inst.admserv.post.local_repos.product.media.remote">
     <title>Copying from a Remote Host</title>
     <para>
      If the &slsa; installation data is provided by a remote machine, log
      in to that machine and push the data to the &admserv; (which has the
      IP address
      <systemitem class="etheraddress">192.168.124.10</systemitem> in the
      following example):
     </para>
     <screen>rsync -avPz /data/sles11sp3/ <replaceable>192.168.124.10</replaceable>:/srv/tftpboot/suse-11.3/install/</screen>
     <para>
      Also make the contents of the &productname; product repository
      available at <filename>/srv/tftpboot/repos/Cloud/</filename> the same
      way:
     </para>
     <screen>rsync -avPz /data/Cloud/ <replaceable>192.168.124.10</replaceable>:/srv/tftpboot/repos/Cloud/</screen>
     <note>
      <title>Target directories must exist</title>
      <para>
       Make sure the target directories for the rsync commands
       (<filename>/srv/tftpboot/suse-11.3/install/</filename> and
       <filename>/srv/tftpboot/repos/Cloud/</filename>) exist on the &admserv;
       prior to executing rsync.
      </para>
     </note>
    </sect4>
   </sect3>
   <sect3 id="sec.depl.inst.admserv.post.local_repos.update">
    <title>Update Repositories</title>
    <para>
     Update repositories are already used when deploying the nodes that will
     build &cloud; in order to ensure they are initially equipped with the
     latest software versions available. If you are using a remote &smt; or
     SUSE Manager server, the update repositories from the remote server are
     used directly. In this case the repository URLs need to be added to the
     file <filename>/etc/crowbar/provisioner.json</filename>. If using
     repositories locally available, the &admserv;'s itself acts as the
     repository provider for all nodes. This requires to make them available
     in <filename>/srv/tftpboot/repos</filename>.
    </para>
    <table>
     <title>Local Update Repositories for &cloud;</title>
     <tgroup cols="2">
      <colspec colnum="1" colname="1" colwidth="25*"/>
      <colspec colnum="2" colname="2" colwidth="75*"/>
      <thead>
       <row>
        <entry>
         <para>
          Repository
         </para>
        </entry>
        <entry>
         <para>
          Directory
         </para>
        </entry>
       </row>
      </thead>
      <tbody>
       <row>
        <entry>
         <para>
          SLES11-SP3-Pool
         </para>
        </entry>
        <entry>
         <para>
          <filename>/srv/tftpboot/repos/SLES11-SP3-Pool</filename>
         </para>
        </entry>
       </row>
       <row>
        <entry>
         <para>
          SLES11-SP3-Updates
         </para>
        </entry>
        <entry>
         <para>
          <filename>/srv/tftpboot/repos/SLES11-SP3-Updates</filename>
         </para>
        </entry>
       </row>
       <row>
        <entry>
         <para>
          SUSE-Cloud-3-Pool
         </para>
        </entry>
        <entry>
         <para>
          <filename>/srv/tftpboot/repos/SUSE-Cloud-3-Pool</filename>
         </para>
        </entry>
       </row>
       <row>
        <entry>
         <para>
          SUSE-Cloud-3-Updates
         </para>
        </entry>
        <entry>
         <para>
          <filename>/srv/tftpboot/repos/SUSE-Cloud-3-Updates</filename>
         </para>
        </entry>
       </row>
      </tbody>
     </tgroup>
    </table>
    <sect4 id="sec.depl.inst.admserv.post.local_repos.update.smt">
     <title>Update Repositories Hosted on an &smt; Server</title>
     <para>
      An &smt; server makes the &suse; update repositories available within
      your network by regularly synchronizing with the &ncc;. To provide
      update repositories for &productname;, you can either use an existing
      &smt; server from a network that can be accessed from the cloud, or
      install an &smt; server on the &admserv;.
     </para>
     <variablelist>
      <varlistentry>
       <term>&smt; Server installed on a Remote Host</term>
       <listitem>
        <para>
         In order to use repositories from a remote &smt; server to deploy
         &cloud; you first need to make sure the products &sls; 11 SP3 and
         Cloud 3 are registered and the corresponding channels are mirrored
         in &smt;. Now you need to enter the repository URLs on the
         <guimenu>Repositories</guimenu> tab in the &yast; &crow; module as
         described in <xref
         linkend="sec.depl.inst.admserv.os.crowbar.repos"/>. A complete set of
         repository URLs is listed below. Note that you need to replace
         <replaceable>smt.&exampledomain;</replaceable> with the fully
         qualified hostname of your &smt; server.
	</para>
	<simplelist>
	 <member>http://<replaceable>smt.&exampledomain;</replaceable>/repo/\$RCE/SLES11-SP3-Pool/sle-11-x86_64/</member>
	 <member>http://<replaceable>smt.&exampledomain;</replaceable>/repo/\$RCE/SLES11-SP3-Updates/sle-11-x86_64/</member>
	 <member>http://<replaceable>smt.&exampledomain;</replaceable>/repo/\$RCE/SUSE-Cloud-3.0-Pool/sle-11-x86_64/</member>
	 <member>http://<replaceable>smt.&exampledomain;</replaceable>/repo/\$RCE/SUSE-Cloud-3.0-Updatessle-11-x86_64/</member>
	</simplelist>
       </listitem>
      </varlistentry>
      <varlistentry>
       <term>&smt; Server installed on the &admserv;</term>
       <listitem>
        <para>
         Link the repositories mirrored by &smt; to
         <filename>/srv/tftpboot</filename>:
        </para>
<screen><?dbsuse-fo font-size="0.63em"?>for REPO in SLES11-SP3-{Pool,Updates} SUSE-Cloud-3.0-{Pool,Updates}; do
  ln -s /srv/www/htdocs/repo/\$RCE/$REPO/sle-11-x86_64 /srv/tftpboot/repos/${REPO/.0/}
done</screen>
       </listitem>
      </varlistentry>
     </variablelist>
    </sect4>
    <sect4 id="sec.depl.inst.admserv.post.local_repos.update.susemgr">
     <title>Update Repositories Hosted on a &susemgr; Server</title>
     <para>
      In order to use repositories from &susemgr; to deploy &cloud; you first
      need to make sure the products &sls; 11 SP3 and &productname;
      &productnumber; are registered and the corresponding channels are
      mirrored in &susemgr;.  By default &susemgr; does not expose
      repositories for direct access.  In order to be able to access them via
      <literal>https</literal>, you need to create a
      <guimenu>Distribution</guimenu> for Autoinstallation for the &sls; 11
      SP3 (x86_64) Product on &susemgr;. Instructions can be found at
      <ulink
	url="https://www.suse.com/documentation/suse_manager/book_susemanager_ref/data/book_susemanager_ref.html"/>
      under the heading <guimenu>Creating Distribution for
      Autoinstallation</guimenu>. During the distribution setup you need to
      provide a <guimenu>Label</guimenu> for the distribution. This label
      will be part of the URL under which the repositories are available. It
      is recommended to choose a name consisting of characters that do not
      need to be URL-encoded, for example
      <literal>sles11-sp3-x86_64</literal>.
     </para>
     <para>
      Creating a distribution for &sls; 11 SP3 not only makes the
      installation data and Update repositories for this product available,
      but also for all registered add-on products, including &productname;
      &productnumber;.
     </para>
     <para>
      The repositories are available under the following URLs.
      <literal>manager.&exampledomain;</literal> needs to be replaced by the
      fully qualified host name of your &susemgr; server and
      <literal>sles11-sp3-x86_64</literal> needs to be replaced by the
      distribution label you specified when setting up the distribution for
      autoinstallation. Note that the URLs are not browseable.
     </para>
     <variablelist>
      <varlistentry>
       <term>SLES11-SP3-Update</term>
       <listitem>
        <para>
         <literal>http://manager.&exampledomain;/ks/dist/child/sles11-sp3-updates-x86_64/sles11-sp3-x86_64/</literal>
        </para>
       </listitem>
      </varlistentry>
      <varlistentry>
       <term>SUSE-Cloud-3-Pool</term>
       <listitem>
        <para>
         <literal>http://manager.&exampledomain;/ks/dist/child/suse-cloud-3.0-pool-x86_64/sles11-sp3-x86_64/</literal>
        </para>
       </listitem>
      </varlistentry>
      <varlistentry>
       <term>SUSE-Cloud-3-Updates</term>
       <listitem>
        <para>
         <literal>http://manager.&exampledomain;/ks/dist/child/suse-cloud-3.0-updates-x86_64/sles11-sp3-x86_64/</literal>
        </para>
       </listitem>
      </varlistentry>
     </variablelist>
     <para>
      To make the repositories available for node deployment, you need to
      enter the repository URLs on the <guimenu>Repositories</guimenu> tab in
      the &yast; &crow; module as described in <xref
      linkend="sec.depl.inst.admserv.os.crowbar.repos"/>.
     </para>
    </sect4>
    <sect4 id="sec.depl.inst.admserv.post.local_repos.update.remote">
     <title>Update Repositories Hosted on a Remote Host</title>
     <para>
      If the update repositories are hosted on a remote host that can be
      accessed from the &admserv; you can either mount them, for example via
      <literal>NFS</literal>, or regularly <command>rsync</command> them.
     </para>
     <para>
      To <literal>NFS</literal>-mount the repositories from a remote host,
      either use the &yast; <guimenu>NFS Client</guimenu> module or edit
      <filename>/etc/fstab</filename>. The local mount point should be
      <filename>/srv/tftpboot/repos/<replaceable>&lt;REPOSITORY_NAME&gt;</replaceable></filename>.
     </para>
     <para>
      To <command>rsync</command> the repositories from a remote host,
      create a daily cron job running the following command on the
      &admserv;. This command will <emphasis>pull</emphasis> the files from
      a host named host.&exampledomain;:
     </para>
<screen><?dbsuse-fo font-size="0.63em"?>for REPO in SLES11-SP3-{Pool,Updates} SUSE-Cloud-3.0-{Pool,Updates}; do
  rsync -avPz host.&exampledomain;:/srv/www/htdocs/repo/\\\$RCE/$REPO/sle-11-x86_64/ \
  /srv/tftpboot/repos/${REPO/.0/}/
done</screen>
     <para>
      Alternatively you may set up the cron job on the remote host and
      <emphasis>push</emphasis> the file to the &admserv; (which has the IP
      address <systemitem class="etheraddress">192.168.124.10</systemitem>
      in the following example):
     </para>
<screen><?dbsuse-fo font-size="0.63em"?>for REPO in SLES11-SP3-{Pool,Updates} SUSE-Cloud-3.0-{Pool,Updates}; do
  rsync -avPz /srv/www/htdocs/repo/\\\$RCE/$REPO/sle-11-x86_64/ \
  <replaceable>192.168.124.10</replaceable>:/srv/tftpboot/repos/${REPO/.0/}/
done</screen>
<note>
 <title>Mind the Trailing Slash</title>
 <para>
  The <command>rsync</command> command must be used with trailing
  slashes in the directory names as shown above. Otherwise rsync would
  copy the repositories into the wrong directory.
 </para>
</note>
    </sect4>
    <sect4 id="sec.depl.inst.admserv.post.local_repos.update.sneaker">
     <title>Update Repositories Hosted on Removable Media (<quote>Sneakernet</quote>)</title>
     <para>
      If your admin network is isolated from other networks, you need to
      manually sync the update repositories from removable media. To do so
      you can either use <command>rsync</command> (see above for an example)
      or <command>cp <option>-axu</option></command>. If copying from a
      &smt; server, see
      <xref linkend="sec.depl.inst.admserv.post.smt_repos"/> for a list of
      directories to copy.
     </para>
    </sect4>
   </sect3>
  </sect2>

  <sect2 id="sec.depl.inst.admserv.post.adm_repos">
   <title>Software Repository Sources on the &admserv;</title>
   <para>
    Update repositories are not only required to deploy &cloud;. The
    &admserv; itself also needs to be kept up-to-date and therefore needs to
    have a proper repository setup. In case you have registered &sls; and
    &productname; during the installation process, the &admserv; already has
    all required update repositories.
   </para>
   <para>
    These repositories are served directly from &ncc;. In order to avoid
    downloading the same patches twice or in case you would like to cut off
    the &admserv; from the internet, it makes sense to change this setup in
    a way that the repositories set up for &cloud; deployment are also used
    on the &admserv;. To do so, you need to disable or delete all services.
    In a second step all &sls; and &cloud; repositories need to be edited in
    order to point to the alternative sources. Editing the repository setup
    can either be done with Zypper or &yast;. Note that changing the
    repository setup on the &admserv; is optional.
   </para>
  </sect2>

  <sect2 id="sec.depl.inst.admserv.post.network">
   <title>Custom Network Configuration</title>
   <para>
    In case you need to adjust the pre-defined network setup of &cloud;
    beyond the scope of changing IP address assignments (as described in
    <xref
      linkend="sec.depl.inst.admserv.os.crowbar"/>), you need to
    manually modify the network &barcl; template. Refer to
    <xref
      linkend="app.deploy.network_json"/> for details.
   </para>
  </sect2>

  <sect2 id="sec.depl.inst.admserv.post.cloud_installation">
   <title>Running the Cloud Installation Script</title>
   <para>
    Before running the cloud installation script to finish the configuration
    of the &admserv; make sure to double-check the following items.
   </para>
   <itemizedlist>
    <title>Final Check Points</title>
    <listitem>
     <para>
      Make sure the network configuration is correct. Run <menuchoice>
      <guimenu>&yast;</guimenu> <guimenu>&crow;</guimenu> </menuchoice> to
      review/change the config. See
      <xref
	linkend="sec.depl.inst.admserv.os.crowbar"/> for further
      instructions.
     </para>
    </listitem>
    <listitem>
     <para>
      Make sure <command>hostname <option>-f</option></command> returns a
      fully qualified hostname. See
      <xref
	linkend="sec.depl.inst.admserv.os.network"/> for further
      instructions.
     </para>
    </listitem>
    <listitem>
     <para>
      Make sure all update and product repositories are available.
      See <xref linkend="sec.depl.inst.admserv.post.local_repos"/> for
      further instructions.
     </para>
    </listitem>
    <listitem>
     <para>
      Make sure the operating system and &productname; are up-to-date and
      have the latest patches installed. Run <command>zypper patch</command>
      to install them.
     </para>
    </listitem>
   </itemizedlist>
   <para>
    Now everything is in place to finally configure the &admserv;. This is
    done by running the script <filename>install-suse-cloud</filename>. This
    command will install and configure &chef;, and use it to complete the
    installation of &crow; and all required &barcl;s. It will take several
    minutes to complete. If you are <emphasis>not</emphasis> using &susemgr;
    to provide update repositories, run the following command:
   </para>
   <screen>screen install-suse-cloud</screen>
   <para>
    In case you are using &susemgr; (as described in
    <xref
      linkend="sec.depl.inst.admserv.post.local_repos.update.susemgr"/>,
    you need to run the following command:
   </para>
   <screen>screen env REPOS_SKIP_CHECKS+=" SLES11-SP3-Pool" install-suse-cloud</screen>
   <important>
    <title>Use a Terminal Multiplexer to run the Cloud Installation Script</title>
    <para>
     Run the installation script <filename>install-suse-cloud</filename>
     inside of a terminal multiplexer like GNU Screen (provided by the
     <systemitem class="resource">screen</systemitem> package).
    </para>
    <para>
     During the run of this script the network will be reconfigured. This
     may result in interrupting the script when being run from a network
     connection (like SSH). Using <command>screen</command> will continue
     running the script in a session to which you can reconnect via
     <command>screen -r</command> if you lose the connection.
    </para>
   </important>
   <para>
    <command>install-suse-cloud</command> will produce a lot of output that
    gets written to a log file located at
    <filename>/var/log/crowbar/install.log</filename>. Check this log file
    in case something goes wrong. You can run
    <command>install-suse-cloud</command> multiple times as long as you have
    not started to deploy the &ostack; services. It is also possible to run
    <command>install-suse-cloud</command> in verbose mode with the
    <option>-v</option> switch. It will show the same output that goes to
    the log file on STDOUT, too.
   </para>
   <para>
    If the script has successfully finished, you will see a message telling
    you how to log in to the &crow; Web interface.
   </para>
   &no_network_changes;
   <figure>
    <title>&crow; Web Interface: Initial State</title>
    <mediaobject>
     <imageobject role="fo">
      <imagedata fileref="depl_node_dashboard_initial.png" width="75%"
		 format="png"/>
     </imageobject>
     <imageobject role="html">
      <imagedata fileref="depl_node_dashboard_initial.png" width="75%"
		 format="png"/>
     </imageobject>
    </mediaobject>
   </figure>
  </sect2>
 </sect1>
</chapter>
